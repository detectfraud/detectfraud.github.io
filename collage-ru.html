            if(!dragging || previewMode || !activeLayer) return;
            layers[activeLayer].x=e.offsetX-dragStartX;
            layers[activeLayer].y=e.offsetY-dragStartY;
            drawAll();
        });
        function stopDrag(){
            if(dragging){ dragging=false; pushHistory(); }
        }
        canvas.addEventListener('mouseup',stopDrag);
        canvas.addEventListener('mouseleave',stopDrag);
        canvas.addEventListener('touchstart',e=>{
            if(previewMode || !activeLayer) return;
            const t=e.touches[0],rect=canvas.getBoundingClientRect();
            dragging=true;
            dragStartX=(t.clientX-rect.left) * (canvas.width/rect.width) - layers[activeLayer].x;
            dragStartY=(t.clientY-rect.top) * (canvas.height/rect.height) - layers[activeLayer].y;
            e.preventDefault();
        });
        canvas.addEventListener('touchmove',e=>{
            if(!dragging || previewMode || !activeLayer) return;
            const t=e.touches[0],rect=canvas.getBoundingClientRect();
            layers[activeLayer].x=(t.clientX-rect.left) * (canvas.width/rect.width) - dragStartX;
            layers[activeLayer].y=(t.clientY-rect.top) * (canvas.height/rect.height) - dragStartY;
            drawAll();
            e.preventDefault();
        });
        canvas.addEventListener('touchend',stopDrag);
        undoBtn.addEventListener('click',()=>{
            if(history.length<=1) return;
            history.pop();
            applySnapshot(history[history.length-1]);
        });
        previewBtn.addEventListener('click',()=>{
            previewMode=true;
            scaleSlider.disabled = true;
            scaleSlider.classList.add('disabled');
            pushHistory();
            toggleButtons();
            drawAll();
        });
        downloadBtn.addEventListener('click',()=>{
            const link=document.createElement('a');
            link.download='collage.jpg';
            link.href=canvas.toDataURL('image/jpeg');
            link.click();
        });
        document.getElementById('updateBtn').addEventListener('click', function () {
            const confirmUpdate = confirm("Вы уверены, что хотите обновить страницу?\n Все незавершенные изменения будут потеряны");
            if (confirmUpdate) {
                const url = window.location.href.split('?')[0];
                window.location.href = url + '?_=' + new Date().getTime();
            }
        });
        function disableContextMenu() {
            return false;
        }
        document.oncontextmenu = disableContextMenu;
        document.onselectstart = disableContextMenu;
        document.ondragstart = disableContextMenu;
        template.onload = () => { drawAll(); };
        renderThumbnails();
        renderVows();
        applySnapshot(history[0] || makeSnapshot());




    </script>
</body>
</html>
