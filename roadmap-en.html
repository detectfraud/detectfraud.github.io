<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <style>
    body { text-align:center; font-family:sans-serif; }
    .venwin { background:#fff; border-radius:10px; padding:10px; display:inline-block; }
    canvas { border:3px solid #bbb; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:block; margin:10px auto; }
    #controls{ margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
    #scaleSlider{ width:420px; }
    button{ padding:8px 12px; }
    .disabled { pointer-events:none; opacity:0.5; filter:grayscale(100%); }
  </style>
</head>
<body>
<fieldset class="venwin" style="height:auto;">
  <center>
    <span style="color:#990000;font-size:x-large;">–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</span><br><br>
    <canvas id="canvas" width="900" height="600"></canvas>
    <div id="controls">
      <label>–§–æ–Ω: <input type="file" id="bgLoader" accept="image/*"></label>
      <label>–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö: <input type="file" id="loveLoader" accept="image/*"></label>
      <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1">
      <button id="undoBtn">‚ü≤ Undo</button>
      <button id="previewBtn">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
      <button id="downloadBtn" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    </div>
  </center>
</fieldset>

<script>
/* === –û–°–ù–û–í–ê –∑ –ö–û–î-1 === */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const bgLoader = document.getElementById('bgLoader');
const loveLoader = document.getElementById('loveLoader');
const scaleSlider = document.getElementById('scaleSlider');
const undoBtn = document.getElementById('undoBtn');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');

/* –ú–∞—Å–∫–∞ (–¥—ñ—Ä–∞) */
let mask = { cx: 0, cy: 0, r: 0 };
let bgHoleActive = false;

/* Drag&Drop */
let dragging=false, dragStartX=0, dragStartY=0;

/* –®–∞—Ä–∏ */
const template = new Image();
template.src = 'images/LoveStone.png';
let layers = {
  bg:{ img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 },
  love:{ img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 }
};
let activeLayer=null;
let previewMode=false;

/* –Ü—Å—Ç–æ—Ä—ñ—è */
const history=[];
const MAX_HISTORY=20;
function makeSnapshot(){ return {
  bg:{...layers.bg}, love:{...layers.love},
  previewMode, activeLayer, bgHoleActive
};}
function pushHistory(){ history.push(makeSnapshot()); if(history.length>MAX_HISTORY) history.shift(); }
function applySnapshot(snap){
  previewMode=!!snap.previewMode; activeLayer=snap.activeLayer; bgHoleActive=!!snap.bgHoleActive;
  ['bg','love'].forEach(k=>{
    if(snap[k] && snap[k].src){
      const img=new Image();
      img.onload=()=>{ layers[k]={...snap[k], img}; drawAll(); };
      img.src=snap[k].src;
    }
  });
  toggleButtons(); drawAll();
}
pushHistory();

/* –ú–∞–ª—é–≤–∞–Ω–Ω—è */
function drawLayerTo(ctxTarget,layer){ if(layer.img){ const w=layer.img.width*layer.scale,h=layer.img.height*layer.scale; ctxTarget.drawImage(layer.img,layer.x-w/2,layer.y-h/2,w,h); } }
function drawLove(ctxTarget,clip=false){ const l=layers.love; if(!l.img) return; const w=l.img.width*l.scale,h=l.img.height*l.scale; ctxTarget.save(); if(clip&&mask.r>0){ ctxTarget.beginPath(); ctxTarget.arc(mask.cx,mask.cy,mask.r,0,Math.PI*2); ctxTarget.clip(); } ctxTarget.drawImage(l.img,l.x-w/2,l.y-h/2,w,h); ctxTarget.restore(); }
function drawBgWithHole(ctxTarget){ if(!layers.bg.img) return; if(!bgHoleActive||mask.r<=0){ drawLayerTo(ctxTarget,layers.bg); return; }
  const off=document.createElement('canvas'); off.width=canvas.width; off.height=canvas.height; const octx=off.getContext('2d'); drawLayerTo(octx,layers.bg);
  octx.globalCompositeOperation='destination-out'; octx.beginPath(); octx.arc(mask.cx,mask.cy,mask.r,0,Math.PI*2); octx.fill(); octx.globalCompositeOperation='source-over'; ctxTarget.drawImage(off,0,0);
}
function drawAll(){ ctx.clearRect(0,0,canvas.width,canvas.height); if(!previewMode){ drawBgWithHole(ctx); drawLove(ctx,false);} else{ drawLove(ctx,true); drawBgWithHole(ctx);} if(template.complete) ctx.drawImage(template,0,0,canvas.width,canvas.height); }
function toggleButtons(){ previewBtn.style.display=previewMode?'none':'inline-block'; downloadBtn.style.display=previewMode?'inline-block':'none'; }

/* –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ */
function handleFileLoad(file,key){ if(!file) return; const r=new FileReader(); r.onload=e=>{ const img=new Image(); img.onload=()=>{ layers[key]={img,src:e.target.result,x:canvas.width/2,y:canvas.height/2,scale:1}; activeLayer=key; scaleSlider.value=1; pushHistory(); drawAll(); }; img.src=e.target.result; }; r.readAsDataURL(file); }
bgLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'bg'));
loveLoader.addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ const img=new Image(); img.onload=()=>{ bgHoleActive=true; layers.love={img,src:ev.target.result,x:canvas.width/2,y:canvas.height/2,scale:1}; activeLayer='love'; scaleSlider.value=1; pushHistory(); drawAll(); }; img.src=ev.target.result; }; r.readAsDataURL(f); });

/* Drag&Drop */
canvas.addEventListener('mousedown',e=>{ if(previewMode||!activeLayer) return; dragging=true; dragStartX=e.offsetX-layers[activeLayer].x; dragStartY=e.offsetY-layers[activeLayer].y; });
canvas.addEventListener('mousemove',e=>{ if(previewMode||!dragging||!activeLayer) return; layers[activeLayer].x=e.offsetX-dragStartX; layers[activeLayer].y=e.offsetY-dragStartY; drawAll(); });
canvas.addEventListener('mouseup',()=>{ if(dragging){dragging=false;pushHistory();} });
canvas.addEventListener('touchstart',e=>{ if(previewMode||!activeLayer) return; const t=e.touches[0],r=canvas.getBoundingClientRect(); dragging=true; dragStartX=t.clientX-r.left-layers[activeLayer].x; dragStartY=t.clientY-r.top-layers[activeLayer].y; e.preventDefault(); });
canvas.addEventListener('touchmove',e=>{ if(!dragging||!activeLayer) return; const t=e.touches[0],r=canvas.getBoundingClientRect(); layers[activeLayer].x=t.clientX-r.left-dragStartX; layers[activeLayer].y=t.clientY-r.top-dragStartY; drawAll(); e.preventDefault(); });
canvas.addEventListener('touchend',()=>{ if(dragging){dragging=false;pushHistory();} });

/* Undo, Preview, Download */
undoBtn.addEventListener('click',()=>{ if(history.length<=1) return; history.pop(); applySnapshot(history[history.length-1]); });
previewBtn.addEventListener('click',()=>{ previewMode=true; pushHistory(); toggleButtons(); drawAll(); });
downloadBtn.addEventListener('click',()=>{ const link=document.createElement('a'); link.download='composition.png'; link.href=canvas.toDataURL('image/png'); link.click(); });

/* === –Ü–ù–¢–ï–ì–†–ê–¶–Ü–Ø –∑ –ö–û–î-2 === */
/* –ö–æ–ª–∏ —à–∞–±–ª–æ–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è */
template.onload=()=>{
  // –í–∞—Ä—ñ–∞–Ω—Ç 1: —à—É–∫–∞—î–º–æ –ø—Ä–æ–∑–æ—Ä—É –¥—ñ–ª—è–Ω–∫—É (—è–∫ —É –ö–û–î-1)
  // –í–∞—Ä—ñ–∞–Ω—Ç 2: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∂–æ—Ä—Å—Ç–∫—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∑ –ö–û–î-2
  const useHardcodedMask=true; // ‚Üê –ø–µ—Ä–µ–º–∏–∫–∞—á

  if(useHardcodedMask){
    mask.cx=(canvas.width/2)+6;
    mask.cy=(canvas.height/2)-115;
    mask.r=98;
  } else {
    // (—Å—Ç–∞—Ä–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ—à—É–∫—É –ø—Ä–æ–∑–æ—Ä–æ—ó –æ–±–ª–∞—Å—Ç—ñ)
    const tempCanvas=document.createElement("canvas"); tempCanvas.width=canvas.width; tempCanvas.height=canvas.height;
    const tctx=tempCanvas.getContext("2d"); tctx.drawImage(template,0,0,canvas.width,canvas.height);
    const imgData=tctx.getImageData(0,0,canvas.width,canvas.height).data;
    let xs=[],ys=[];
    for(let y=0;y<canvas.height;y++){ for(let x=0;x<canvas.width;x++){ let a=imgData[(y*canvas.width+x)*4+3]; if(a<50){ xs.push(x); ys.push(y);} } }
    if(xs.length){ mask.cx=xs.reduce((a,b)=>a+b,0)/xs.length; mask.cy=ys.reduce((a,b)=>a+b,0)/ys.length; mask.r=Math.max(...xs.map((v,i)=>Math.hypot(v-mask.cx,ys[i]-mask.cy))); }
  }
  drawAll();
};
</script>
</body>
</html>
