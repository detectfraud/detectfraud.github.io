<!-- –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ -->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<style>
  body { text-align:center; font-family:sans-serif; }
  .venwin { background: #fff; border-radius:10px; padding:10px; display:inline-block; }
  canvas { border:3px solid #bbb; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:block; margin:10px auto; }
  #controls{ margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  #scaleSlider{ width:420px; }
  button{ padding:8px 12px; }
</style>
</head>
<body>


<fieldset class="venwin" style="height:auto;">
  <center>
    <span style="color:#990000;font-size:x-large;">–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</span><br><br>
    <canvas id="canvas" width="900" height="600" style="border:1px solid #ccc;"></canvas>


    <div id="controls">
      <label>–§–æ–Ω: <input type="file" id="bgLoader" accept="image/*"></label>
      <label>–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö: <input type="file" id="loveLoader" accept="image/*"></label>
      <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1">
      <button id="undoBtn">‚ü≤ Undo</button>
      <button id="previewBtn">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
      <button id="downloadBtn" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    </div>
  </center>
</fieldset>


<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const bgLoader = document.getElementById('bgLoader');
const loveLoader = document.getElementById('loveLoader');
const scaleSlider = document.getElementById('scaleSlider');
const undoBtn = document.getElementById('undoBtn');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');


// —à–∞–±–ª–æ–Ω (–ø–æ–≤–µ—Ä—Ö)
const template = new Image();
template.src = 'images/LoveStone.png';


// –º–æ–¥–µ–ª—å —à–∞—Ä—ñ–≤: –∑–±–µ—Ä—ñ–≥–∞—î–º–æ img (Image) —ñ dataURL —É src –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó
let layers = {
  bg: { img: null, src: null, x: canvas.width/2, y: canvas.height/2, scale: 1 },
  love: { img: null, src: null, x: canvas.width/2, y: canvas.height/2, scale: 1 }
};


let activeLayer = null; // 'bg' –∞–±–æ 'love'
let previewMode = false;


// —ñ—Å—Ç–æ—Ä—ñ—è: –º–∞—Å–∏–≤ —Å–Ω—î–ø—à–æ—Ç—ñ–≤ { bg:{src,x,y,scale}, love:{...}, previewMode, activeLayer }
const history = [];
const MAX_HISTORY = 20;


function makeSnapshot(){
  return {
