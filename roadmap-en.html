<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: url(images/unamed.jpg) repeat scroll top left; }
        .venwin { border-radius: 10px; display: inline-block; background-color: rgba(255, 255, 255, 0.5); padding: 20px 20px; box-sizing: border-box;}
        canvas {
            border: 3px solid #bbb;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0,0,0,.1);
            display: block;
            margin: 10px auto;
            width: 630px;
            height: 420px;
            transition: transform 0.3s ease-in-out;
            transform-origin: center center;
            cursor:pointer;
            position: relative;
            z-index: 10;
        }
        .preview-zoom-in:hover {
            transform: scale(1.43);
        }
        #scaleSlider { width: 420px; }
        button { padding: 8px 12px; cursor: pointer; border-radius: 8px; }
        .disabled { pointer-events: none; opacity: .5; filter: grayscale(100%); }
        .gallery-container { display: flex; align-items: flex-start; justify-content: center; gap: 10px; margin-top: 10px; }
        .gallery-block { display: flex; flex-direction: column; align-items: center; gap: 10px; }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –Ω–æ–≤–æ—ó –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤, –∞–¥–∞–ø—Ç–æ–≤–∞–Ω—ñ –∑ "Gallery" */
        .gallery-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 630px; /* –ê–¥–∞–ø—Ç—É—î–º–æ –ø—ñ–¥ —à–∏—Ä–∏–Ω—Éthumbnails –∑ Collage */
            justify-content: center;
        }
        .gallery {
            display: flex;
            gap: 10px;
            overflow: hidden;
            width: calc(3 * 120px + 2 * 10px); /* 3 –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏ * 120px + 2 –ø—Ä–æ–º—ñ–∂–∫–∏ –ø–æ 10px */
        }
        .gallery-content { /* –î–æ–¥–∞–Ω–æ –¥–ª—è JS –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            display: flex;
            gap: 10px;
            transition: transform 0.3s ease-in-out;
        }
        .gallery input[type="radio"] { display: none; }
        .gallery label {
            flex-shrink: 0; /* –©–æ–± –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏ –Ω–µ —Å—Ç–∏—Å–∫–∞–ª–∏—Å—è */
            display: block;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            transition: border 0.3s;
        }
        .gallery label img {
            width: 120px;
            height: 80px;
            object-fit: cover;
            display: block;
        }
        .gallery input[type="radio"]:checked + label {
            border: 2px solid #007bff;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—ó/–≤–∏–±—Ä–∞–Ω–æ—ó –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏, —â–æ–± –≤–æ–Ω–∞ –±—É–ª–∞ disabled */
        .gallery label.disabled-thumb {
            cursor: not-allowed;
            opacity: .5;
            filter: grayscale(100%);
            border: 2px solid red; /* –î–æ–¥–∞—î–º–æ —Ä–∞–º–∫—É –¥–ª—è disabled */
        }
        .nav {
            background: #fff;
            border: 1px solid #ccc;
            padding: 5px 10px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 6px;
        }
        .nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        /* –ö—ñ–Ω–µ—Ü—å —Å—Ç–∏–ª—ñ–≤ –¥–ª—è –Ω–æ–≤–æ—ó –≥–∞–ª–µ—Ä–µ—ó */


        .collage {
            position: relative;
            display: inline-block;
            margin-top: 0;
        }
        .gallery-container.vows .labels { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; margin-bottom: 5px; }
        .gallery-container.vows .labels .label1 { grid-column: 1; font-weight: bold; margin-left: 70px; }
        .gallery-container.vows .labels .label2 { grid-column: 3; font-weight: bold; }
        /* .arrow, .arow —Ç–µ–ø–µ—Ä –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤ */
        .button-row { display: flex; justify-content: center; align-items: center; gap: 10px; }
        #fot { display: inline-block; cursor: pointer; border-radius: 8px; width: 108px; height: 72px; background-image: url(https://detectfraud.github.io/gallery/Para.png); background-repeat: no-repeat; background-size: contain; }
        #fot:hover { mix-blend-mode: luminosity; }
        #fot:active { mix-blend-mode: exclusion; }
        .imagbox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%) scale(0.1);
            width: 825px;
            height: 510px;
            opacity: 0;
            transition: all 0.9s ease;
            z-index: 9999;
            border-radius: 12px;
            box-shadow: 0 0 25px rgba(0,0,0,0.7);
            pointer-events: none;
            background: #fff;
            object-fit: cover;
        }
        .imagbox.show {
            opacity: 1;
            transform: translate(-50%,-50%) scale(0.6);
        }
        .photo-block { margin-left: 100px; }
        #updateBtn { margin-left: 300px; font-weight: bold; color: red; }
        .donate-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1000;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @media (max-width: 768px) {
            .venwin { padding: 10px; }
            canvas { width: 95%; height: auto; }
            #scaleSlider { width: 95%; }
            .gallery-container { flex-direction: column; align-items: center; }
            /* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –Ω–æ–≤–æ—ó –≥–∞–ª–µ—Ä–µ—ó –ø—ñ–¥ –º–æ–±—ñ–ª—å–Ω—ñ */
            .gallery-wrapper { width: 100%; justify-content: center; }
            .gallery { width: calc(3 * 108px + 2 * 10px); /* 3 –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏ * 108px + 2 –ø—Ä–æ–º—ñ–∂–∫–∏ */ }
            .gallery label img { width: 108px; height: 72px; }
            /* –ö—ñ–Ω–µ—Ü—å –∞–¥–∞–ø—Ç–∞—Ü—ñ—ó */
            .arrow:first-child, .arrow:last-child { margin: 0 10px; }
            .arow:first-child, .arow:last-child { margin: 0 10px; }
            .photo-block { margin-left: 0; }
            #updateBtn { margin-left: 0; margin-top: 10px; }
            .gallery-container.vows .labels { grid-template-columns: 1fr 1fr; }
            .gallery-container.vows .labels .label1, .gallery-container.vows .labels .label2 { margin: 0; }
            .donate-btn { bottom: 10px; right: 10px; width: 50px; height: 50px; font-size: 24px; }
        }
    </style>
</head>
<body>
    <fieldset class="venwin" style="height:auto;">
        <div class="collage" id="collage">
            <canvas id="canvas" width="900" height="600" style="cursor: pointer;border:1px solid #ccc;"></canvas>
            <img id="imagePreview" class="imagbox" src="" alt="Image Preview">
        </div>
        <br>
        <b style="text-align: center;">–†–æ–∑–º—ñ—Ä</b>
        <br>
        <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1" style="cursor: pointer;">
        <div class="gallery-container">
            <div class="gallery-block" id="vowsi">
                <b>–§–æ–Ω</b><br /><br />
                <div class="gallery-wrapper">
                    <button class="nav prev" id="prevBgBtn">‚ü®</button>
                    <div class="gallery" id="bgGallery">
                        <div class="gallery-content" id="bgGalleryContent"></div>
                    </div>
                    <button class="nav next" id="nextBgBtn">‚ü©</button>
                </div>
                </div>
            <div class="gallery-block photo-block">
                <b>–í–∞—à–µ —Ñ–æ—Ç–æ</b><br /><br />
                <div>
                    <label id="fot" class="disabled" title="–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö"></label>
                </div>
            </div>
        </div>
        <div class="gallery-container vows" id="vowse" style="display:none;">
            <div class="gallery-block">
                <div class="labels">
                    <span class="label1">–ù–∞–¥–ø–∏—Å</span>
                    <span class="label2">–ö–ª—è—Ç–≤–∞ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö</span>
                </div>
                <div class="gallery-row">
                    <span class="arow" onclick="prevVow()">&#10094;</span>
                    <div class="thumbnails" id="thumbsVows"></div>
                    <span class="arow" onclick="nextVow()">&#10095;</span>
                </div>
            </div>
        </div>
        <p class="button-row">
            <button id="undoBtn" type="button">‚ü≤ Undo</button>
            <button id="previewBtn" type="button" class="disabled">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
            <button id="downloadBtn" type="button" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
            <button id="updateBtn" type="button">UPDATE</button>
        </p>
        <br>
    </fieldset>
    <a href="https://example.com/donate" class="donate-btn" target="_blank" title="–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç">‚ù§Ô∏è</a>
    <input type="file" id="bgLoader" style="display:none">
    <input type="file" id="loveLoader" style="display:none">
    <script>
        /* === Collage JS === */
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        // –°—Ç–∞—Ä—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤ –≤–∏–¥–∞–ª–µ–Ω–æ
        const thumbsVows = document.getElementById('thumbsVows'); // –ó–∞–ª–∏—à–∞—î—Ç—å—Å—è –¥–ª—è –≥–∞–ª–µ—Ä–µ—ó –∫–ª—è—Ç–≤
        const loveLoader = document.getElementById('loveLoader');
        const scaleSlider = document.getElementById('scaleSlider');
        const undoBtn = document.getElementById('undoBtn');
        const previewBtn = document.getElementById('previewBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const bgLoader = document.getElementById('bgLoader');
        const collage = document.getElementById('collage');
        const vowse = document.getElementById('vowse');
        const vowsi = document.getElementById('vowsi');
        const photoBlock = document.querySelector('.photo-block');
        const loveStoneName = "LoveStones";
        const DONATE_URL = "https://example.com/donate";
        const imagePreview = document.getElementById('imagePreview');

        // –ù–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–æ—ó –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤
        const bgGalleryContent = document.getElementById('bgGalleryContent');
        const prevBgBtn = document.getElementById('prevBgBtn');
        const nextBgBtn = document.getElementById('nextBgBtn');

        const url = "https://detectfraud.github.io/gallery/";
        const bgImages = [ "nature(1)","nature(2)","nature(3)","nature(4)","nature(5)", "nature(6)","nature(7)","nature(8)","nature(9)","Fon" ];
        const fullBgImages = bgImages.map(name => url + name + ".jpeg");
        let bgStartIndex = 0; // –î–ª—è –Ω–æ–≤–æ—ó –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤
        const visibleBgCount = 3; // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–¥–∏–º–∏—Ö –º—ñ–Ω—ñ–∞—Ç—é—Ä –¥–ª—è —Ñ–æ–Ω—ñ–≤
        const thumbnailBgWidth = 130; // 120px width + 10px gap

        const vows = ["Eternity","Fidelity","Joy","Love","Strength","Tenderness","Trust","Unity","Heart","Hearts"];
        const fullVows = vows.map(name => url + name + ".png");
        let vowIndex = 0; // –î–ª—è —Å—Ç–∞—Ä–æ—ó –≥–∞–ª–µ—Ä–µ—ó –∫–ª—è—Ç–≤
        const lovestoneImages = ["LoveStones"];
        const fullLovestones = lovestoneImages.map(name => url + name + ".png");
        let lovestoneIndex = 0; // –î–ª—è —Å—Ç–∞—Ä–æ—ó –≥–∞–ª–µ—Ä–µ—ó –∫–ª—è—Ç–≤

        let activeThumb = null; // –î–ª—è —Å—Ç–∞—Ä–æ—ó –≥–∞–ª–µ—Ä–µ—ó –∫–ª—è—Ç–≤
        let activeBgRadio = null; // –î–ª—è –Ω–æ–≤–æ—ó –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤

        // –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏ (–¥–ª—è —Å—Ç–∞—Ä–æ—ó –≥–∞–ª–µ—Ä–µ—ó –∫–ª—è—Ç–≤)
        function setActiveThumb(thumbElement) {
            const allThumbs = document.querySelectorAll('#thumbsVows .thumb');
            allThumbs.forEach(thumb => {
                thumb.classList.remove('active');
                thumb.classList.remove('disabled');
            });
            thumbElement.classList.add('active');
            thumbElement.classList.add('disabled');
            activeThumb = thumbElement;
        }

        // --- –ù–û–í–Ü –§–£–ù–ö–¶–Ü–á –î–õ–Ø –Ü–ù–¢–ï–ì–†–û–í–ê–ù–û–á –ì–ê–õ–ï–†–ï–á –§–û–ù–Ü–í ---
        function createBgGallery() {
            bgGalleryContent.innerHTML = '';
            fullBgImages.forEach((src, index) => {
                const imgName = src.split("/").pop().split(".")[0];
                const input = document.createElement("input");
                input.type = "radio";
                input.name = "bgThumb";
                input.id = `bgThumb${index}`;

                const label = document.createElement("label");
                label.setAttribute("for", input.id);

                const img = new Image();
                img.src = src;
                img.alt = imgName;
                label.appendChild(img);

                if (imgName === "Fon") {
                    label.title = "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤—ñ–π —Ñ–æ–Ω";
                }

                input.addEventListener("change", () => {
                    if (imgName === "Fon") {
                        bgLoader.click();
                    } else {
                        handleFileFromGallery(src, 'bg');
                    }
                    imagePreview.classList.remove('show');
                    if (activeBgRadio) {
                        activeBgRadio.classList.remove('disabled-thumb');
                    }
                    label.classList.add('disabled-thumb');
                    activeBgRadio = label;
                });

                let hoverTimeout;
                label.addEventListener('mouseenter', () => {
                    clearTimeout(hoverTimeout);
                    hoverTimeout = setTimeout(() => {
                        imagePreview.src = src;
                        imagePreview.classList.add('show');
                    }, 700);
                });

                label.addEventListener('mouseleave', () => {
                    clearTimeout(hoverTimeout);
                    imagePreview.classList.remove('show');
                });
                bgGalleryContent.appendChild(input);
                bgGalleryContent.appendChild(label);
            });
            // –í–∏–±–∏—Ä–∞—î–º–æ –ø–µ—Ä—à–∏–π –µ–ª–µ–º–µ–Ω—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            const firstRadio = bgGalleryContent.querySelector('input[type="radio"]');
            if(firstRadio) {
                firstRadio.checked = true;
                const firstLabel = firstRadio.nextElementSibling;
                firstLabel.classList.add('disabled-thumb');
                activeBgRadio = firstLabel;
                handleFileFromGallery(fullBgImages[0], 'bg'); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–µ—Ä—à–∏–π —Ñ–æ–Ω
            }
        }

        function updateBgGalleryDisplay() {
            const offset = -bgStartIndex * thumbnailBgWidth;
            bgGalleryContent.style.transform = `translateX(${offset}px)`;

            prevBgBtn.disabled = (bgStartIndex === 0);
            nextBgBtn.disabled = (bgStartIndex >= fullBgImages.length - visibleBgCount);
        }

        prevBgBtn.addEventListener("click", () => {
            if (bgStartIndex > 0) {
                bgStartIndex--;
                updateBgGalleryDisplay();
            }
        });
        nextBgBtn.addEventListener("click", () => {
            if (bgStartIndex < fullBgImages.length - visibleBgCount) {
                bgStartIndex++;
                updateBgGalleryDisplay();
            }
        });
        // --- –ö–Ü–ù–ï–¶–¨ –ù–û–í–ò–• –§–£–ù–ö–¶–Ü–ô –î–õ–Ø –ì–ê–õ–ï–†–ï–á –§–û–ù–Ü–í ---


        // --- –§–£–ù–ö–¶–Ü–á –î–õ–Ø –°–¢–ê–†–û–á –ì–ê–õ–ï–†–ï–á –ö–õ–Ø–¢–í (–±–µ–∑ –∑–º—ñ–Ω) ---
        function renderVows() {
            thumbsVows.innerHTML = "";
            activeThumb = null;
            const combinedVows = [...fullLovestones, ...fullVows]; // –û–±'—î–¥–Ω–∞–Ω–æ –¥–ª—è —î–¥–∏–Ω–æ—ó –≥–∞–ª–µ—Ä–µ—ó
            combinedVows.slice(vowIndex, vowIndex + 3).forEach(src => {
                const key = src.includes(loveStoneName) ? 'lovestone' : 'vow';
                createThumb(src, thumbsVows, key);
            });
        }
        function createThumb(src, container, key) {
            const wrapper = document.createElement("div");
            wrapper.className = "thumb-wrapper";
            const imgName = src.split("/").pop().split(".")[0];
            const thumb = document.createElement("img");
            thumb.className = "thumb";
            thumb.src = src;
            let timer;
            wrapper.addEventListener('mouseenter', () => {
                timer = setTimeout(() => {
                    imagePreview.src = src;
                    imagePreview.classList.add('show');
                }, 700);
            });
            wrapper.addEventListener('mouseleave', () => {
                clearTimeout(timer);
                imagePreview.classList.remove('show');
            });
            thumb.onclick = () => {
                handleFileFromGallery(src, key);
                setActiveThumb(thumb);
            };
            wrapper.appendChild(thumb);
            container.appendChild(wrapper);
        }
        function prevVow(){ vowIndex=(vowIndex-3+ (fullLovestones.length + fullVows.length))%(fullLovestones.length + fullVows.length); renderVows(); }
        function nextVow(){ vowIndex=(vowIndex+3)%(fullLovestones.length + fullVows.length); renderVows(); }
        // --- –ö–Ü–ù–ï–¶–¨ –§–£–ù–ö–¶–Ü–ô –î–õ–Ø –°–¢–ê–†–û–á –ì–ê–õ–ï–†–ï–á –ö–õ–Ø–¢–í ---

        function handleFileFromGallery(src, key) {
            if (previewMode) {
                previewMode = false;
                canvas.classList.remove('preview-zoom-in');
            }
            if (key === 'vow' || key === 'lovestone') {
                vowse.style.display = 'flex'; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ flex –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–∞–ª–µ—Ä–µ—ó vows
                vowsi.style.display = 'none';
                photoBlock.style.display = 'none';
            } else if (key === 'bg') {
                vowse.style.display = 'none';
                vowsi.style.display = 'flex';
                photoBlock.style.display = 'flex';
            }
            imagePreview.classList.remove('show');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                layers[key].img = img;
                layers[key].src = src;
                if (key === 'vow') {
                    layers[key].scale = 0.5;
                    layers[key].x = (canvas.width / 2) + 14.28;
                    layers[key].y = (canvas.height) - 14.28;
                } else if (key === 'lovestone') {
                    layers[key].scale = 0.5;
                    layers[key].x = canvas.width / 2;
                    layers[key].y = canvas.height / 2;
                } else {
                    layers[key].x = canvas.width / 2;
                    layers[key].y = canvas.height / 2;
                    layers[key].scale = 1;
                }
                activeLayer = key;
                if (activeLayer) {
                    scaleSlider.value = layers[activeLayer].scale;
                }
                scaleSlider.disabled = false;
                scaleSlider.classList.remove('disabled');
                pushHistory();
                drawAll();
                if (key === 'bg') {
                    document.getElementById('fot').classList.remove('disabled');
                }
                if (layers.love.img || layers.lovestone.img) {
                    document.getElementById('previewBtn').classList.remove('disabled');
                }
                previewBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'none';
            };
            img.src = src;
        }

        function handleFileLoad(file,key){
            if(!file) return;
            const reader=new FileReader();
            reader.onload=e=>{
                const data=e.target.result;
                const img=new Image();
                img.onload=()=>{
                    layers[key].img=img;
                    layers[key].src=data;
                    layers[key].x = canvas.width / 2;
                    layers[key].y = canvas.height / 2;
                    layers[key].scale = 1;
                    activeLayer = key;
                    if (activeLayer) {
                        scaleSlider.value = layers[activeLayer].scale;
                    }
                    scaleSlider.disabled = false;
                    scaleSlider.classList.remove('disabled');
                    pushHistory();
                    drawAll();
                    if (key === 'bg') {
                        document.getElementById('fot').classList.remove('disabled');
                        // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –º—ñ–Ω—ñ–∞—Ç—é—Ä—É –¥–ª—è "Fon" —É –Ω–æ–≤—ñ–π –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤
                        const fonLabel = bgGalleryContent.querySelector(`label[title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤—ñ–π —Ñ–æ–Ω"]`);
                        if(fonLabel) {
                            if (activeBgRadio) activeBgRadio.classList.remove('disabled-thumb');
                            fonLabel.classList.add('disabled-thumb');
                            fonLabel.previousElementSibling.checked = true; // –ü–æ–∑–Ω–∞—á–∞—î–º–æ —Ä–∞–¥—ñ–æ–∫–Ω–æ–ø–∫—É
                            activeBgRadio = fonLabel;
                        }
                    }
                    if (key === 'love') {
                        document.getElementById('previewBtn').classList.remove('disabled');
                    }
                };
                img.src=data;
            };
            reader.readAsDataURL(file);
        }
        bgLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'bg'));
        loveLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'love'));
        document.getElementById("fot").onclick=()=>loveLoader.click();
        const template=new Image(); template.src='images/composit.png';
        const HOLE_OFFSET_X=6, HOLE_OFFSET_Y=-115, HOLE_RADIUS=98;
        let mask={cx:canvas.width/2+HOLE_OFFSET_X, cy:canvas.height/2+HOLE_OFFSET_Y, r:HOLE_RADIUS};
        let layers={
            bg:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},
            love:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},
            vow:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},
            lovestone:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1}
        };
        let activeLayer=null, previewMode=false, bgHoleActive=true;
        const history=[]; const MAX_HISTORY=20;
        function makeSnapshot(){ return { bg:{...layers.bg}, love:{...layers.love}, loveScale: scaleSlider.value, vow:{...layers.vow}, lovestone:{...layers.lovestone}, previewMode, activeLayer, bgHoleActive, bgStartIndex, activeBgRadioId: activeBgRadio ? activeBgRadio.id : null }; }

        function pushHistory(){ history.push(makeSnapshot()); if(history.length>MAX_HISTORY) history.shift(); }
        function applySnapshot(s){
            previewMode=!!s.previewMode; activeLayer=s.activeLayer||null; bgHoleActive=!!s.bgHoleActive;
            bgStartIndex = s.bgStartIndex !== undefined ? s.bgStartIndex : 0; // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ bgStartIndex
            updateBgGalleryDisplay(); // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–∞–ª–µ—Ä–µ—ó —Ñ–æ–Ω—ñ–≤

            if (s.activeBgRadioId) {
                const radio = document.getElementById(s.activeBgRadioId);
                if (radio) {
                    radio.checked = true;
                    const label = radio.nextElementSibling;
                    if (activeBgRadio) activeBgRadio.classList.remove('disabled-thumb');
                    label.classList.add('disabled-thumb');
                    activeBgRadio = label;
                }
            } else {
                if (activeBgRadio) activeBgRadio.classList.remove('disabled-thumb');
                activeBgRadio = null;
            }

            if (s.bg.img) {
                document.getElementById('fot').classList.remove('disabled');
            } else {
                document.getElementById('fot').classList.add('disabled');
            }
            if (s.love.img) {
                document.getElementById('previewBtn').classList.remove('disabled');
            } else {
                document.getElementById('previewBtn').classList.add('disabled');
            }
            ['bg','love','vow','lovestone'].forEach(key=>{
                const v=s[key];
                if(v && v.src){
                    const img=new Image();
                    img.onload=()=>{ layers[key].img=img; layers[key].src=v.src; layers[key].x=v.x; layers[key].y=v.y; layers[key].scale=v.scale; drawAll(); };
                    img.src=v.src;
                } else {
                    layers[key].img=null; layers[key].src=null;
                    layers[key].x=v? v.x: canvas.width/2;
                    layers[key].y=v? v.y: canvas.height/2;
                    layers[key].scale=v? v.scale:1;
                }
            });
            toggleButtons();
        }
        function drawLayerTo(ctxTarget, layer){
            if(!layer||!layer.img) return;
            const w = layer.img.width * layer.scale;
            const h = layer.img.height * layer.scale;
            const x = layer.x;
            const y = layer.y;
            ctxTarget.drawImage(layer.img, x - w/2, y - h/2, w, h);
        }
        function drawLove(ctxTarget, clip=false){
            const L=layers.love;
            if(!L||!L.img) return;
            const w = L.img.width * L.scale;
            const h = L.img.height * L.scale;
            const x = L.x;
            const y = L.y;
            ctxTarget.save();
            if(clip && mask.r>0){
                ctxTarget.beginPath();
                ctxTarget.arc(mask.cx, mask.cy, mask.r, 0, Math.PI * 2);
                ctxTarget.clip();
            }
            ctxTarget.drawImage(L.img, x - w/2, y - h/2, w, h);
            ctxTarget.restore();
        }
        function drawBgWithHole(ctxTarget){
            if(!layers.bg.img) return;
            if(!bgHoleActive||mask.r<=0){ drawLayerTo(ctxTarget,layers.bg); return; }
            const off = document.createElement('canvas');
            off.width = canvas.width;
            off.height = canvas.height;
            const octx = off.getContext('2d');
            drawLayerTo(octx, layers.bg);
            octx.globalCompositeOperation = 'destination-out';
            octx.beginPath();
            octx.arc(mask.cx, mask.cy, mask.r, 0, Math.PI * 2);
            octx.fill();
            octx.globalCompositeOperation = 'source-over';
            ctxTarget.drawImage(off, 0, 0);
        }
        function drawAll(){
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBgWithHole(ctx);
            drawLove(ctx, previewMode);
            if(template.complete) {
                ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
            }
            drawLayerTo(ctx, layers.vow);
            drawLayerTo(ctx, layers.lovestone);
        }
        function toggleButtons(){
            if(previewMode){
                previewBtn.style.display = 'none';
                downloadBtn.style.display = 'inline-block';
                vowsi.style.display = 'none';
                photoBlock.style.display = 'none';
                vowse.style.display = 'flex'; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ flex
                canvas.classList.add('preview-zoom-in');
                activeLayer = null;
            } else {
                previewBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'none';
                vowsi.style.display = 'flex'; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ flex
                photoBlock.style.display = 'flex'; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ flex
                vowse.style.display = 'none';
                canvas.classList.remove('preview-zoom-in');
            }
        }
        scaleSlider.addEventListener('input',()=>{
            if(!activeLayer) return;
            layers[activeLayer].scale=parseFloat(scaleSlider.value);
            drawAll();
        });
        let dragging=false, dragStartX=0, dragStartY=0;
        canvas.addEventListener('mousedown',e=>{
            if(previewMode || !activeLayer) return;
            dragging=true;
            dragStartX=e.offsetX-layers[activeLayer].x;
            dragStartY=e.offsetY-layers[activeLayer].y;
        });
        canvas.addEventListener('mousemove',e=>{
            if(!dragging || previewMode || !activeLayer) return;
            layers[activeLayer].x=e.offsetX-dragStartX;
            layers[activeLayer].y=e.offsetY-dragStartY;
            drawAll();
        });
        function stopDrag(){
            if(dragging){ dragging=false; pushHistory(); }
        }
        canvas.addEventListener('mouseup',stopDrag);
        canvas.addEventListener('mouseleave',stopDrag);
        canvas.addEventListener('touchstart',e=>{
            if(previewMode || !activeLayer) return;
            const t=e.touches[0],rect=canvas.getBoundingClientRect();
            dragging=true;
            dragStartX=(t.clientX-rect.left) * (canvas.width/rect.width) - layers[activeLayer].x;
            dragStartY=(t.clientY-rect.top) * (canvas.height/rect.height) - layers[activeLayer].y;
            e.preventDefault();
        });
        canvas.addEventListener('touchmove',e=>{
            if(!dragging || previewMode || !activeLayer) return;
            const t=e.touches[0],rect=canvas.getBoundingClientRect();
            layers[activeLayer].x=(t.clientX-rect.left) * (canvas.width/rect.width) - dragStartX;
            layers[activeLayer].y=(t.clientY-rect.top) * (canvas.height/rect.height) - dragStartY;
            drawAll();
            e.preventDefault();
        });
        canvas.addEventListener('touchend',stopDrag);
        undoBtn.addEventListener('click',()=>{
            if(history.length<=1) return;
            history.pop();
            applySnapshot(history[history.length-1]);
        });
        previewBtn.addEventListener('click',()=>{
            previewMode=true;
            scaleSlider.disabled = true;
            scaleSlider.classList.add('disabled');
            pushHistory();
            toggleButtons();
            drawAll();
        });
        downloadBtn.addEventListener('click',()=>{
            const link=document.createElement('a');
            link.download='collage.jpg';
            link.href=canvas.toDataURL('image/jpeg');
            link.click();
        });
        document.getElementById('updateBtn').addEventListener('click', function () {
            const confirmUpdate = confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É? –£—Å—ñ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω—ñ –∑–º—ñ–Ω–∏ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.");
            if (confirmUpdate) {
                const url = window.location.href.split('?')[0];
                window.location.href = url + '?_=' + new Date().getTime();
            }
        });
        function disableContextMenu() {
            return false;
        }
        document.oncontextmenu = disableContextMenu;
        document.onselectstart = disableContextMenu;
        document.ondragstart = disableContextMenu;
        template.onload = () => { drawAll(); };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–æ–≤–∏—Ö —Ç–∞ —Å—Ç–∞—Ä–∏—Ö –≥–∞–ª–µ—Ä–µ–π
        createBgGallery();
        updateBgGalleryDisplay();
        renderVows();
        applySnapshot(history[0] || makeSnapshot());
    </script>
</body>
</html>
