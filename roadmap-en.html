<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <style>
    body{ text-align:center; font-family:sans-serif; }
    .venwin{ background:#fff; border-radius:10px; padding:10px; display:inline-block; }
    canvas{ border:3px solid #bbb; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:block; margin:10px auto; }
    #controls{ margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
    #scaleSlider{ width:420px; }
    button{ padding:8px 12px; }
    .disabled{ pointer-events:none; opacity:.5; filter:grayscale(100%); }
  </style>
</head>
<body>
  <fieldset class="venwin" style="height:auto;">
    <center>
      <span style="color:#990000;font-size:x-large;">–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</span><br><br>
      <!-- –ü–æ–ª–æ—Ç–Ω–æ -->
      <canvas id="canvas" width="900" height="600" style="border:1px solid #ccc;"></canvas>
</center>
      <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
      <div id="controls"></div>
         <br><br>
         <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1"><br><br>
        <label>–§–æ–Ω:&nbsp;<input type="file" id="bgLoader" accept="image/*"></label><br><br>
        <label>–§–æ—Ç–æ:<input type="file" id="loveLoader" accept="image/*"></label><br><br>        
        <button id="undoBtn" type="button">‚ü≤ Undo</button>
        <button id="previewBtn" type="button">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
        <button id="downloadBtn" type="button" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>      
    </fieldset>
  <script>
    /* === –ë–ê–ó–ê === */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const bgLoader = document.getElementById('bgLoader');
    const loveLoader = document.getElementById('loveLoader');
    const scaleSlider = document.getElementById('scaleSlider');
    const undoBtn = document.getElementById('undoBtn');
    const previewBtn = document.getElementById('previewBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    // –®–∞–±–ª–æ–Ω (–ø–æ–≤–µ—Ä—Ö —É—Å—å–æ–≥–æ)
    const template = new Image();
    template.src = 'images/composit.png';

    // –ú–∞—Å–∫–∞ (—Ü–µ–Ω—Ç—Ä —ñ —Ä–∞–¥—ñ—É—Å –æ—Ç–≤–æ—Ä—É)
    const HOLE_OFFSET_X = 6;     // —è–∫ —É –ö–û–î-2
    const HOLE_OFFSET_Y = -115;  // —è–∫ —É –ö–û–î-2
    const HOLE_RADIUS   = 98;    // —è–∫ —É –ö–û–î-2
    let mask = { cx: 0, cy: 0, r: 0 };

    function setDefaultMask(){
      mask.cx = canvas.width / 2 + HOLE_OFFSET_X;
      mask.cy = canvas.height / 2 + HOLE_OFFSET_Y;
      mask.r  = HOLE_RADIUS;
    }

    // –®–∞—Ä–∏
    let layers = {
      bg:   { img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 },
      love: { img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 }
    };

    let activeLayer = null;   // 'bg' | 'love'
    let previewMode = false;  // false = —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è, true = –ø–µ—Ä–µ–≥–ª—è–¥
    let bgHoleActive = false; // —á–∏ —Ä–æ–±–∏—Ç–∏ ¬´–¥—ñ—Ä–∫—É¬ª —É —Ñ–æ–Ω—ñ

    // –Ü—Å—Ç–æ—Ä—ñ—è
    const history = [];
    const MAX_HISTORY = 20;

    function makeSnapshot(){
      return {
        bg:{ src:layers.bg.src, x:layers.bg.x, y:layers.bg.y, scale:layers.bg.scale },
        love:{ src:layers.love.src, x:layers.love.x, y:layers.love.y, scale:layers.love.scale },
        previewMode, activeLayer, bgHoleActive
      };
    }
    function pushHistory(){
      history.push(makeSnapshot());
      if(history.length > MAX_HISTORY) history.shift();
    }
    function applySnapshot(s){
      previewMode = !!s.previewMode;
      activeLayer = s.activeLayer || null;
      bgHoleActive = !!s.bgHoleActive;
      const jobs = [];

      ['bg','love'].forEach(key=>{
        const v = s[key];
        if(v && v.src){
          const img = new Image();
          const p = new Promise(res=>{
            img.onload = ()=>{
              layers[key].img = img;
              layers[key].src = v.src;
              layers[key].x = v.x; layers[key].y = v.y; layers[key].scale = v.scale;
              res();
            };
            img.onerror = ()=>{ layers[key].img = null; layers[key].src = null; res(); };
          });
          img.src = v.src;
          jobs.push(p);
        } else {
          layers[key].img = null; layers[key].src = null;
          layers[key].x = v ? v.x : canvas.width/2;
          layers[key].y = v ? v.y : canvas.height/2;
          layers[key].scale = v ? v.scale : 1;
        }
      });

      toggleButtons();
      if(jobs.length) return Promise.all(jobs).then(drawAll);
      drawAll();
      return Promise.resolve();
    }

    // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
    pushHistory();

    /* === –ú–∞–ª—é–≤–∞–Ω–Ω—è === */
    function drawLayerTo(ctxTarget, layer){
      if(!layer || !layer.img) return;
      const w = layer.img.width * layer.scale;
      const h = layer.img.height * layer.scale;
      ctxTarget.drawImage(layer.img, layer.x - w/2, layer.y - h/2, w, h);
    }

    function drawLove(ctxTarget, clip=false){
      const L = layers.love; if(!L || !L.img) return;
      const w = L.img.width * L.scale, h = L.img.height * L.scale;
      ctxTarget.save();
      if(clip && mask.r > 0){
        ctxTarget.beginPath();
        ctxTarget.arc(mask.cx, mask.cy, mask.r, 0, Math.PI*2);
        ctxTarget.clip();
      }
      ctxTarget.drawImage(L.img, L.x - w/2, L.y - h/2, w, h);
      ctxTarget.restore();
    }

    function drawBgWithHole(ctxTarget){
      if(!layers.bg.img){ return; }
      if(!bgHoleActive || mask.r <= 0){
        // –±–µ–∑ –¥—ñ—Ä–∫–∏
        drawLayerTo(ctxTarget, layers.bg);
        return;
      }
      // –∑ –¥—ñ—Ä–∫–æ—é (–æ—Ñ—Ñ—Å–∫—Ä—ñ–Ω)
      const off = document.createElement('canvas');
      off.width = canvas.width; off.height = canvas.height;
      const octx = off.getContext('2d');
      drawLayerTo(octx, layers.bg);

      octx.globalCompositeOperation = 'destination-out';
      octx.beginPath();
      octx.arc(mask.cx, mask.cy, mask.r, 0, Math.PI*2);
      octx.fill();
      octx.globalCompositeOperation = 'source-over';

      ctxTarget.drawImage(off, 0, 0);
    }

    function drawAll(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!previewMode){
        // –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: –Ω–∏–∑ —Ñ–æ–Ω (–∑/–±–µ–∑ –¥—ñ—Ä–∫–∏), –ø–æ—Ç—ñ–º Love (–ø—ñ–¥ —à–∞–±–ª–æ–Ω–æ–º)
        drawBgWithHole(ctx);
        drawLove(ctx, false);
      } else {
        // –ü–µ—Ä–µ–≥–ª—è–¥: Love –ø–æ–∑–∞–¥—É —Ñ–æ–Ω—É
        drawLove(ctx, true);
        drawBgWithHole(ctx);
      }
      if(template.complete) ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
    }

    function toggleButtons(){
      if(previewMode){
        previewBtn.style.display = 'none';
        downloadBtn.style.display = 'inline-block';
        setDisabled(true);
      } else {
        previewBtn.style.display = 'inline-block';
        downloadBtn.style.display = 'none';
        setDisabled(false);
      }
    }

    /* === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ === */
    function handleFileLoad(file, key){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        const data = e.target.result;
        const img = new Image();
        img.onload = ()=>{
          layers[key].img = img;
          layers[key].src = data;
          layers[key].x = canvas.width/2;
          layers[key].y = canvas.height/2;
          layers[key].scale = 1;
          activeLayer = key;
          scaleSlider.value = 1;
          pushHistory();
          drawAll();
        };
        img.src = data;
      };
      reader.readAsDataURL(file);
    }

    bgLoader.addEventListener('change', e=>handleFileLoad(e.target.files[0], 'bg'));
    loveLoader.addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        const data = ev.target.result;
        const img = new Image();
        img.onload = ()=>{
          // Love —Å—Ç–∞—î –º—ñ–∂ —à–∞–±–ª–æ–Ω–æ–º —ñ —Ñ–æ–Ω–æ–º –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
          layers.love.img = img;
          layers.love.src = data;
          layers.love.x = canvas.width/2;
          layers.love.y = canvas.height/2;
          layers.love.scale = 1;
          activeLayer = 'love';
          scaleSlider.value = 1;

          // –î—ñ—Ä–∫–∞ —É —Ñ–æ–Ω—ñ –º–∞—î –±—É—Ç–∏ –≤–∂–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ (—á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–î—ñ—Ä–∞¬ª),
          // –∞–ª–µ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–±—É–≤ ‚Äî —É–≤—ñ–º–∫–Ω–µ–º–æ:
          if(mask.r <= 0) setDefaultMask();
          bgHoleActive = true;

          pushHistory();
          drawAll();
        };
        img.src = data;
      };
      reader.readAsDataURL(file);
    });

    /* === –ú–∞—Å—à—Ç–∞–± === */
    scaleSlider.addEventListener('input', ()=>{
      if(!activeLayer) return;
      layers[activeLayer].scale = parseFloat(scaleSlider.value);
      drawAll();
    });

    /* === –ü–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —à–∞—Ä—É === */
    let dragging = false, dragStartX = 0, dragStartY = 0;
    canvas.addEventListener('mousedown', e=>{
      if(previewMode || !activeLayer) return;
      dragging = true;
      dragStartX = e.offsetX - layers[activeLayer].x;
      dragStartY = e.offsetY - layers[activeLayer].y;
    });
    canvas.addEventListener('mousemove', e=>{
      if(previewMode || !dragging || !activeLayer) return;
      layers[activeLayer].x = e.offsetX - dragStartX;
      layers[activeLayer].y = e.offsetY - dragStartY;
      drawAll();
    });
    function stopDrag(){
      if(previewMode) return;
      if(dragging){ dragging = false; pushHistory(); }
    }
    canvas.addEventListener('mouseup', stopDrag);
    canvas.addEventListener('mouseleave', stopDrag);

    // Touch
    canvas.addEventListener('touchstart', e=>{
      if(previewMode || !activeLayer) return;
      const t = e.touches[0], rect = canvas.getBoundingClientRect();
      dragging = true;
      dragStartX = t.clientX - rect.left - layers[activeLayer].x;
      dragStartY = t.clientY - rect.top - layers[activeLayer].y;
      e.preventDefault();
    });
    canvas.addEventListener('touchmove', e=>{
      if(previewMode || !dragging || !activeLayer) return;
      const t = e.touches[0], rect = canvas.getBoundingClientRect();
      layers[activeLayer].x = t.clientX - rect.left - dragStartX;
      layers[activeLayer].y = t.clientY - rect.top - dragStartY;
      drawAll(); e.preventDefault();
    });
    canvas.addEventListener('touchend', stopDrag);

    /* === UNDO === */
    undoBtn.addEventListener('click', ()=>{
      if(history.length <= 1) return;
      history.pop();
      const prev = history[history.length-1];
      applySnapshot(prev);
    });

    /* === PREVIEW === */
    previewBtn.addEventListener('click', ()=>{
      previewMode = true;  // Love –æ–ø–∏–Ω—è—î—Ç—å—Å—è –ø–æ–∑–∞–¥—É —Ñ–æ–Ω—É (—É drawAll –ø–æ—Ä—è–¥–æ–∫ —à–∞—Ä—ñ–≤ —ñ–Ω—à–∏–π)
      pushHistory();
      toggleButtons();
      drawAll();
    });

    /* === DOWNLOAD === */
    downloadBtn.addEventListener('click', ()=>{
      const link = document.createElement('a');
      link.download = 'composition.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    /* === –ú–∞—Å–∫–∞ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É ===
       –£–Ω–∏–∫–∞—î–º–æ –ø–æ–≤–Ω–æ–≥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ (–±–æ –ø–æ–∑–∞ —à–∞–±–ª–æ–Ω–æ–º —Ç–∞–∫–æ–∂ –ø—Ä–æ–∑–æ—Ä–æ),
       —Ç–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤—ñ–¥–æ–º—ñ –æ—Ñ—Å–µ—Ç–∏/—Ä–∞–¥—ñ—É—Å (—è–∫ —É —Ç–≤–æ—î–º—É –ö–û–î-2). */
    template.onload = ()=>{
      setDefaultMask();
      drawAll();
    };

    // –°—Ç–∞—Ä—Ç–æ–≤–µ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è
    applySnapshot(history[0] || makeSnapshot());

    /* === –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è/—Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç—Ä–æ–ª—ñ–≤ —É preview === */
    function setDisabled(state){
      // –ù–µ –±–ª–æ–∫—É—î–º–æ Undo/Download; –±–ª–æ–∫—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ –º–∞—Å—à—Ç–∞–±
      [bgLoader, loveLoader, scaleSlider].forEach(el=>{
        el.disabled = !!state;
        el.classList.toggle('disabled', !!state);
      });
    }

    // –ö–ù–û–ü–ö–ê ¬´–î–Ü–†–ê¬ª ‚Äî —Ä–æ–±–∏–º–æ –æ—Ç–≤—ñ—Ä —É —Ñ–æ–Ω—ñ
    loveLoader.addEventListener('click', roundWin);

    // ======= –í–ò–ü–†–ê–í–õ–ï–ù–ê roundWin() =======
    function roundWin(){
      // –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ –º–∞—Å–∫—É
      if(mask.r <= 0) setDefaultMask();
      // –ê–∫—Ç–∏–≤—É—î–º–æ ¬´–¥—ñ—Ä–∫—É¬ª —É —Ñ–æ–Ω—ñ
      bgHoleActive = true;
      pushHistory();
      drawAll();
    }
  </script>
</body>
</html>
