<!-- –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ñ–∞–π–ª: –†–µ–¥–∞–∫—Ç–æ—Ä + —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∞ —Ä–æ–±–æ—Ç–∞ –≥–∞–ª–µ—Ä–µ–π -->
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ)</title>
  <style>
/*—Ä–µ–¥–∞–∫—Ç–æ—Ä*/
body {
  font-family: sans-serif;
  text-align: center;
  background: #f5f5f5;
}

.venwin {
    background: #fff;
    border-radius: 10px;
    padding: 10px;
    display: inline-block;
}

canvas {
    border: 3px solid #bbb;
    border-radius: 6px;
    box-shadow: 0 6px 18px rgba(0,0,0,.1);
    display: block;
    margin: 10px auto;
}

#scaleSlider {
    width: 420px;
}

button {
    padding: 8px 12px;
}

.disabled {
    pointer-events: none;
    opacity: .5;
    filter: grayscale(100%);
}

/*–ì–∞–ª–µ—Ä–µ—ó*/
.gallery-container {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
}

.gallery-block {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.gallery-block > div {
  display: flex;
  align-items: center;
  justify-content: center;
}

.arrow, .arow {
  font-size: 20px;
  cursor: pointer;
  user-select: none;
  padding: 3px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.arrow:first-child { margin-right: -110px; }
.arrow:last-child { margin-left: -110px; }
.arow:first-child { margin-right: -60px; }
.arow:last-child { margin-left: -60px; }  

.thumbnails {
  display: flex;
  gap: 10px;
  overflow: hidden;
  width: 600px;
  justify-content: center;
}
.thumb-wrapper { position: relative; }

.thumb {
  width: 108px;
  height: 72px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
  transition: all 0.3s ease;
  z-index: 1;
}

.collage {
  position: relative;
  display: inline-block;
  margin-top: 40px;
}

.collage img.overlay {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 500px;
  border-radius: 8px;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
}

#fot {
  display: inline-block;
  cursor: pointer;
  border-radius: 8px;
  width: 108px;
  height: 72px;
  background-image: url(https://detectfraud.github.io/gallery/Para.png);
  background-repeat: no-repeat;
  background-size: contain;
}
#fot:hover { mix-blend-mode: luminosity; }
#fot:active { mix-blend-mode: exclusion; }

.imagbox {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 825px;
  height: 510px;
  transform: translate(-50%, -50%) scale(0.1);
  opacity: 0;
  transition: all 0.5s ease;
  z-index: 9999;
  border-radius: 12px;
  box-shadow: 0 0 25px rgba(0,0,0,0.7);
  pointer-events: none;
  background: #fff;
}

.thumb-wrapper:hover .imagbox {
  opacity: 1;
  transform: translate(-50%, -50%) scale(0.6);
}
.photo-block { margin-left: 100px; }
/* –∑—Ä–æ–±–∏—Ç–∏ —Å—Ç—Ä—ñ–ª–∫–∏ –ø–æ–≤–µ—Ä—Ö –º—ñ–Ω—ñ–∞—Ç—é—Ä */
.arrow, .arow {
  position: relative;
  z-index: 3;   /* > 1 —É .thumb */
}
.gallery-container.vows .labels {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏ */
  text-align: center;
  margin-bottom: 5px;
}

.gallery-container.vows .labels .label1 {
  grid-column: 1; /* –Ω–∞–¥ –ø–µ—Ä—à–æ—é –º—ñ–Ω—ñ–∞—Ç—é—Ä–æ—é */
  font-weight: bold;
  margin-left: 70px; 
}

.gallery-container.vows .labels .label2 {
  grid-column: 3; /* –Ω–∞–¥ —Ç—Ä–µ—Ç—å–æ—é –º—ñ–Ω—ñ–∞—Ç—é—Ä–æ—é */
  font-weight: bold;
  }
#updateBtn { margin-left: 500px; }
  </style>
</head>
<body>
  <fieldset class="venwin" style="height:auto;">
<!-- –ö–æ–ª–∞–∂ -->
<div class="collage" id="collage">
  <canvas id="canvas" width="900" height="600" style="border:1px solid #ccc;"></canvas>
</div>
      <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->      
        <br><input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1"><br><br>
<!-- === –ì–∞–ª–µ—Ä–µ—è —Ñ–æ–Ω—ñ–≤ === -->
<div class="gallery-container">
  <div class="gallery-block">
    <b>–§–æ–Ω</b>
    <div>
      <span class="arrow" onclick="prevSlide()">&#10094;</span>
      <div class="thumbnails" id="thumbs"></div>
      <span class="arrow" onclick="nextSlide()">&#10095;</span>
    </div>
  </div>

  <div class="gallery-block photo-block">
    <b>–§–æ—Ç–æ</b>
    <label id="fot" title="–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö"></label>
  </div>
</div>

<!-- === –ì–∞–ª–µ—Ä–µ—è –∫–ª—è—Ç–≤ === -->
<div class="gallery-container vows">
  <div class="gallery-block">
    <div class="labels">
      <span class="label1">–ù–∞–¥–ø–∏—Å</span>
      <span class="label2">–ö–ª—è—Ç–≤–∞ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö</span>
    </div>

    <div class="gallery-row">
      <span class="arow" onclick="prevVow()">&#10094;</span>
      <div class="thumbnails" id="thumbsVows"></div>
      <span class="arow" onclick="nextVow()">&#10095;</span>
    </div>
  </div>
</div>

  <!-- –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ input -->
<input type="file" id="bgLoader" style="display:none">
<input type="file" id="loveLoader" style="display:none">
        <button id="undoBtn" type="button">‚ü≤ Undo</button>
        <button id="previewBtn" type="button">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
        <button id="downloadBtn" type="button" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    <button id="updateBtn" type="button" style="background: red;">UPDATE</button>
    </fieldset>

  <script>
    /* === –ë–ê–ó–ê === */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // FIX: –ø—Ä–∏–±—Ä–∞–≤ –¥—É–±–ª—é–≤–∞–Ω–Ω—è —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é —á—ñ—Ç–∫—ñ —ñ–º–µ–Ω–∞
    const thumbsContainer = document.getElementById('thumbs');         // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º—ñ–Ω—ñ–∞—Ç—é—Ä —Ñ–æ–Ω—ñ–≤
    const thumbsVows = document.getElementById('thumbsVows');         // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–ª—è—Ç–≤
    const collage = document.getElementById('collage');

    const bgLoader = document.getElementById('bgLoader');
    const loveLoader = document.getElementById('loveLoader');
    const scaleSlider = document.getElementById('scaleSlider');
    const undoBtn = document.getElementById('undoBtn');
    const previewBtn = document.getElementById('previewBtn');
    const downloadBtn = document.getElementById('downloadBtn');

/* === –ì–∞–ª–µ—Ä–µ—è —Ñ–æ–Ω—ñ–≤ (–¥–∞–Ω—ñ) === */
const jpg = ".jpeg";
const url = "https://detectfraud.github.io/gallery/";
const images = [
  "nature(1)","nature(2)","nature(3)",
  "nature(4)","nature(5)","nature(6)",
  "nature(7)","nature(8)","nature(9)",
  "Fon"
];
let fullImages = images.map(name => url + name + jpg);

let startIndex = 0;

function renderThumbnails() {
  thumbsContainer.innerHTML = "";
  const slice = fullImages.slice(startIndex, startIndex + 3);
  slice.forEach(src => createThumb(src, thumbsContainer, false));
}

function createThumb(src, container, isVow) {
  const wrapper = document.createElement("div");
  wrapper.className = "thumb-wrapper";

  const imgName = src.split("/").pop().split(".")[0];

  const thumb = document.createElement("img");
  thumb.className = "thumb";
  thumb.src = src;

  const big = document.createElement("img");
  big.className = "imagbox";
  big.src = src;

  if (!isVow && imgName === "Fon") {
    thumb.title = "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤—ñ–π —Ñ–æ–Ω";
    thumb.onclick = () => bgLoader.click();
  } else {
    // FIX: –∑–∞–º—ñ—Å—Ç—å –¥–æ–¥–∞–≤–∞–Ω–Ω—è <img> –≤ DOM, –º–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä—è–º–æ –≤ —à–∞—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (canvas)
    // –Ø–∫—â–æ thumb ‚Äî —Ñ–æ–Ω => –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —à–∞—Ä 'bg', —è–∫—â–æ –∫–ª—è—Ç–≤–∞ (isVow) => –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ 'love' —à–∞—Ä
    if(!isVow){
      thumb.onclick = () => loadImageFromURL(src, 'bg');
    } else {
      thumb.onclick = () => loadImageFromURL(src, 'love');
    }
  }

  wrapper.appendChild(thumb);
  wrapper.appendChild(big);
  container.appendChild(wrapper);
}

function prevSlide() {
  startIndex = (startIndex - 3 + fullImages.length) % fullImages.length;
  renderThumbnails();
}
function nextSlide() {
  startIndex = (startIndex + 3) % fullImages.length;
  renderThumbnails();
}

// remove old addOverlay DOM-only function (we no longer use it)


// FIX: –∑–∞–º—ñ–Ω—é—î–º–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è document.body.bg –Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –∑ canvas
bgLoader.addEventListener("change", e => {
  const file = e.target.files[0];
  if (file) {
    // —ñ–Ω—Ç–µ–≥—Ä—É—î–º–æ –≤ —à–∞—Ä bg —á–µ—Ä–µ–∑ —ñ—Å–Ω—É—é—á–∏–π handleFileLoad
    handleFileLoad(file, 'bg');
  }
});

// –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö (–≤–∏–∫–ª–∏–∫–∞—î —ñ–Ω–ø—É—Ç)
document.getElementById("fot").onclick = () => loveLoader.click();

// FIX: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ -> —ñ–Ω—Ç–µ–≥—Ä—É—î–º–æ –≤ —à–∞—Ä 'love' —á–µ—Ä–µ–∑ handleFileLoad
loveLoader.addEventListener("change", e => {
  const file = e.target.files[0];
  if (file) {
    handleFileLoad(file, 'love');
  }
});

// –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–µ–Ω–¥–µ—Ä 
renderThumbnails();

/* === –ì–∞–ª–µ—Ä–µ—è –∫–ª—è—Ç–≤ === */
const png = ".png";
const vows = ["LoveStones","Eternity","Fidelity","Joy","LoveStones","Love","Strength","Tenderness","LoveStones","Trust","Unity","Heart"];
const fullVows = vows.map(name => url + name + png);

let vowIndex = 0;

function renderVows() {
  thumbsVows.innerHTML = "";
  const slice = fullVows.slice(vowIndex, vowIndex + 4);
  slice.forEach(src => createThumb(src, thumbsVows, true));
}

function prevVow() {
  vowIndex = (vowIndex - 4 + fullVows.length) % fullVows.length;
  renderVows();
}
function nextVow() {
  vowIndex = (vowIndex + 4) % fullVows.length;
  renderVows();
}

renderVows();

    // –®–∞–±–ª–æ–Ω (–ø–æ–≤–µ—Ä—Ö —É—Å—å–æ–≥–æ)
    const template = new Image();
    template.src = 'images/composit.png';

    // –ú–∞—Å–∫–∞ (—Ü–µ–Ω—Ç—Ä —ñ —Ä–∞–¥—ñ—É—Å –æ—Ç–≤–æ—Ä—É)
    const HOLE_OFFSET_X = 6;     // —è–∫ —É –ö–û–î-2
    const HOLE_OFFSET_Y = -115;  // —è–∫ —É –ö–û–î-2
    const HOLE_RADIUS   = 98;    // —è–∫ —É –ö–û–î-2
    let mask = { cx: 0, cy: 0, r: 0 };

    function setDefaultMask(){
      mask.cx = canvas.width / 2 + HOLE_OFFSET_X;
      mask.cy = canvas.height / 2 + HOLE_OFFSET_Y;
      mask.r  = HOLE_RADIUS;
    }

    // –®–∞—Ä–∏ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–∞–∫ —Å–∞–º–æ bg —ñ love (–±–µ–∑ —É—Å–∫–ª–∞–¥–Ω–µ–Ω—å)
    let layers = {
      bg:   { img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 },
      love: { img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 }
    };

    let activeLayer = null;   // 'bg' | 'love'
    let previewMode = false;  // false = —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è, true = –ø–µ—Ä–µ–≥–ª—è–¥
    let bgHoleActive = false; // —á–∏ —Ä–æ–±–∏—Ç–∏ ¬´–¥—ñ—Ä–∫—É¬ª —É —Ñ–æ–Ω—ñ

    // –Ü—Å—Ç–æ—Ä—ñ—è
    const history = [];
    const MAX_HISTORY = 20;

    function makeSnapshot(){
      return {
        bg:{ src:layers.bg.src, x:layers.bg.x, y:layers.bg.y, scale:layers.bg.scale },
        love:{ src:layers.love.src, x:layers.love.x, y:layers.love.y, scale:layers.love.scale },
        previewMode, activeLayer, bgHoleActive
      };
    }
    function pushHistory(){
      history.push(makeSnapshot());
      if(history.length > MAX_HISTORY) history.shift();
    }
    async function applySnapshot(s){
      previewMode = !!s.previewMode;
      activeLayer = s.activeLayer || null;
      bgHoleActive = !!s.bgHoleActive;
      const jobs = [];

      ['bg','love'].forEach(key=>{
        const v = s[key];
        if(v && v.src){
          const img = new Image();
          img.crossOrigin = "anonymous"; // FIX: –¥–æ–¥–∞—î–º–æ crossOrigin, —â–æ–± –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ CORS-–ø—Ä–æ–±–ª–µ–º–∏
          const p = new Promise(res=>{
            img.onload = ()=>{
              layers[key].img = img;
              layers[key].src = v.src;
              layers[key].x = v.x; layers[key].y = v.y; layers[key].scale = v.scale;
              res();
            };
            img.onerror = ()=>{ layers[key].img = null; layers[key].src = null; res(); };
          });
          img.src = v.src;
          jobs.push(p);
        } else {
          layers[key].img = null; layers[key].src = null;
          layers[key].x = v ? v.x : canvas.width/2;
          layers[key].y = v ? v.y : canvas.height/2;
          layers[key].scale = v ? v.scale : 1;
        }
      });

      toggleButtons();
      if(jobs.length) await Promise.all(jobs).then(drawAll);
      else drawAll();
      return;
    }

    // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
    pushHistory();

    /* === –ú–∞–ª—é–≤–∞–Ω–Ω—è === */
    function drawLayerTo(ctxTarget, layer){
      if(!layer || !layer.img) return;
      const w = layer.img.width * layer.scale;
      const h = layer.img.height * layer.scale;
      ctxTarget.drawImage(layer.img, layer.x - w/2, layer.y - h/2, w, h);
    }

    function drawLove(ctxTarget, clip=false){
      const L = layers.love; if(!L || !L.img) return;
      const w = L.img.width * L.scale, h = L.img.height * L.scale;
      ctxTarget.save();
      if(clip && mask.r > 0){
        ctxTarget.beginPath();
        ctxTarget.arc(mask.cx, mask.cy, mask.r, 0, Math.PI*2);
        ctxTarget.clip();
      }
      ctxTarget.drawImage(L.img, L.x - w/2, L.y - h/2, w, h);
      ctxTarget.restore();
    }

    function drawBgWithHole(ctxTarget){
      if(!layers.bg.img){ return; }
      if(!bgHoleActive || mask.r <= 0){
        // –±–µ–∑ –¥—ñ—Ä–∫–∏
        drawLayerTo(ctxTarget, layers.bg);
        return;
      }
      // –∑ –¥—ñ—Ä–∫–æ—é (–æ—Ñ—Ñ—Å–∫—Ä—ñ–Ω)
      const off = document.createElement('canvas');
      off.width = canvas.width; off.height = canvas.height;
      const octx = off.getContext('2d');
      drawLayerTo(octx, layers.bg);

      octx.globalCompositeOperation = 'destination-out';
      octx.beginPath();
      octx.arc(mask.cx, mask.cy, mask.r, 0, Math.PI*2);
      octx.fill();
      octx.globalCompositeOperation = 'source-over';

      ctxTarget.drawImage(off, 0, 0);
    }

    function drawAll(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!previewMode){
        // –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: –Ω–∏–∑ —Ñ–æ–Ω (–∑/–±–µ–∑ –¥—ñ—Ä–∫–∏), –ø–æ—Ç—ñ–º Love (–ø—ñ–¥ —à–∞–±–ª–æ–Ω–æ–º)
        drawBgWithHole(ctx);
        drawLove(ctx, false);
      } else {
        // –ü–µ—Ä–µ–≥–ª—è–¥: Love –ø–æ–∑–∞–¥—É —Ñ–æ–Ω—É
        drawLove(ctx, true);
        drawBgWithHole(ctx);
      }
      if(template.complete) ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
    }

    function toggleButtons(){
      if(previewMode){
        previewBtn.style.display = 'none';
        downloadBtn.style.display = 'inline-block';
        setDisabled(true);
      } else {
        previewBtn.style.display = 'inline-block';
        downloadBtn.style.display = 'none';
        setDisabled(false);
      }
    }

    /* === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ (—Ñ–∞–π–ª–∏ –∑ input) === */
    function handleFileLoad(file, key){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        const data = e.target.result;
        const img = new Image();
        img.crossOrigin = "anonymous"; // FIX: –ø—Ä–æ–±—É—î–º–æ —É–Ω–∏–∫–Ω—É—Ç–∏ CORS –ø—Ä–æ–±–ª–µ–º –¥–ª—è –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö URL
        img.onload = ()=>{
          layers[key].img = img;
          layers[key].src = data;
          layers[key].x = canvas.width/2;
          layers[key].y = canvas.height/2;
          layers[key].scale = 1;
          activeLayer = key;
          scaleSlider.value = 1;
          pushHistory();
          drawAll();
        };
        img.src = data;
      };
      reader.readAsDataURL(file);
    }

    // FIX: –¥–æ–¥–∞–≤ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ URL (–¥–ª—è –º—ñ–Ω—ñ–∞—Ç—é—Ä –≥–∞–ª–µ—Ä–µ—ó)
    function loadImageFromURL(src, key){
      if(!src) return;
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>{
        layers[key].img = img;
        layers[key].src = src;
        layers[key].x = canvas.width/2;
        layers[key].y = canvas.height/2;
        layers[key].scale = 1;
        activeLayer = key;
        scaleSlider.value = 1;
        pushHistory();
        drawAll();
      };
      img.onerror = ()=>{
        console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:", src);
      };
      img.src = src;
    }

    // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ change –¥–ª—è —ñ–Ω–ø—É—Ç—ñ–≤ (–≤–∂–µ –∑—Ä–æ–±–ª–µ–Ω—ñ –≤–∏—â–µ ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤–æ –¥—É–±–ª—é–≤–∞—Ç–∏ –Ω–µ —Ç—Ä–µ–±–∞)
    bgLoader.addEventListener('change', e=>handleFileLoad(e.target.files[0], 'bg'));
    loveLoader.addEventListener('change', e=>handleFileLoad(e.target.files[0], 'love'));

    /* === –ú–∞—Å—à—Ç–∞–± === */
    scaleSlider.addEventListener('input', ()=>{
      if(!activeLayer) return;
      layers[activeLayer].scale = parseFloat(scaleSlider.value);
      drawAll();
    });

    /* === –ü–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —à–∞—Ä—É === */
    let dragging = false, dragStartX = 0, dragStartY = 0;
    canvas.addEventListener('mousedown', e=>{
      if(previewMode || !activeLayer) return;
      dragging = true;
      dragStartX = e.offsetX - layers[activeLayer].x;
      dragStartY = e.offsetY - layers[activeLayer].y;
    });
    canvas.addEventListener('mousemove', e=>{
      if(previewMode || !dragging || !activeLayer) return;
      layers[activeLayer].x = e.offsetX - dragStartX;
      layers[activeLayer].y = e.offsetY - dragStartY;
      drawAll();
    });
    function stopDrag(){
      if(previewMode) return;
      if(dragging){ dragging = false; pushHistory(); }
    }
    canvas.addEventListener('mouseup', stopDrag);
    canvas.addEventListener('mouseleave', stopDrag);

    // Touch
    canvas.addEventListener('touchstart', e=>{
      if(previewMode || !activeLayer) return;
      const t = e.touches[0], rect = canvas.getBoundingClientRect();
      dragging = true;
      dragStartX = t.clientX - rect.left - layers[activeLayer].x;
      dragStartY = t.clientY - rect.top - layers[activeLayer].y;
      e.preventDefault();
    });
    canvas.addEventListener('touchmove', e=>{
      if(previewMode || !dragging || !activeLayer) return;
      const t = e.touches[0], rect = canvas.getBoundingClientRect();
      layers[activeLayer].x = t.clientX - rect.left - dragStartX;
      layers[activeLayer].y = t.clientY - rect.top - dragStartY;
      drawAll(); e.preventDefault();
    });
    canvas.addEventListener('touchend', stopDrag);

    /* === UNDO === */
    undoBtn.addEventListener('click', async ()=>{
      if(history.length <= 1) return;
      history.pop();
      const prev = history[history.length-1];
      await applySnapshot(prev); // FIX: —á–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (applySnapshot –º–æ–∂–µ –±—É—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—é)
    });

    /* === PREVIEW === */
    previewBtn.addEventListener('click', ()=>{
      previewMode = true;  // Love –æ–ø–∏–Ω—è—î—Ç—å—Å—è –ø–æ–∑–∞–¥—É —Ñ–æ–Ω—É (—É drawAll –ø–æ—Ä—è–¥–æ–∫ —à–∞—Ä—ñ–≤ —ñ–Ω—à–∏–π)
      pushHistory();
      toggleButtons();
      drawAll();
    });

    /* === DOWNLOAD === */
    downloadBtn.addEventListener('click', ()=>{
      const link = document.createElement('a');
      link.download = 'composition.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    /* === –ú–∞—Å–∫–∞ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É ===
       –£–Ω–∏–∫–∞—î–º–æ –ø–æ–≤–Ω–æ–≥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ (–±–æ –ø–æ–∑–∞ —à–∞–±–ª–æ–Ω–æ–º —Ç–∞–∫–æ–∂ –ø—Ä–æ–∑–æ—Ä–æ),
       —Ç–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤—ñ–¥–æ–º—ñ –æ—Ñ—Å–µ—Ç–∏/—Ä–∞–¥—ñ—É—Å (—è–∫ —É —Ç–≤–æ—î–º—É –ö–û–î-2). */
    template.onload = ()=>{
      setDefaultMask();
      drawAll();
    };

    // –°—Ç–∞—Ä—Ç–æ–≤–µ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞–Ω–Ω—è
    (async ()=>{
      await applySnapshot(history[0] || makeSnapshot());
      renderThumbnails();
      renderVows();
    })();

    /* === –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è/—Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç—Ä–æ–ª—ñ–≤ —É preview === */
    function setDisabled(state){
      // FIX: –∑–∞–º—ñ—Å—Ç—å —Å–ø—Ä–æ–±–∏ —Å—Ç–∞–≤–∏—Ç–∏ disabled –Ω–∞ div, –≤—ñ–¥–∫–ª—é—á–∞—î–º–æ pointer-events —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö –≥–∞–ª–µ—Ä–µ–π
      thumbsContainer.style.pointerEvents = state ? 'none' : 'auto';
      thumbsVows.style.pointerEvents = state ? 'none' : 'auto';

      [bgLoader, loveLoader, scaleSlider].forEach(el=>{
        el.disabled = !!state;
        el.classList.toggle('disabled', !!state);
      });
    }
  </script>
</body>
</html>
