<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>ÐšÐ°Ð¼Ñ–Ð½ÑŒ Ð»ÑŽÐ±Ð¾Ð²Ñ–</title>
<style>
body { text-align:center; font-family:sans-serif; }
.venwin {
  background: #fff;
  border-radius:10px;
  padding:10px;
  display:inline-block;
}
canvas {
  border:3px solid #bbb;
  border-radius:3%;
  box-shadow:0 6px 18px rgba(0,0,0,.1);
  display:block;
  margin:10px auto;
}
</style>
</head>
<body>

<fieldset class="venwin">
<center>  <span style="color:#990000;font-size:x-large;">ÐšÐ°Ð¼Ñ–Ð½ÑŒ Ð»ÑŽÐ±Ð¾Ð²Ñ–</span><br><br>
  
    <canvas id="canvas" width="900" height="600" style="border:1px solid #ccc;"></canvas>
    <br><br>

    <input type="file" id="upload" accept="image/*"><br><br>


    <input type="range" id="scaleSlider" min="0.5" max="2" value="1" step="0.01">

    <button id="downloadBtn">ðŸ“¥ Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸</button>
  </center>
</fieldset>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const URLS = {
  shablon:  "images/shablon.png",
  template: "images/LoveStone.png",
  bg:       "images/priroda.jpg"
};

let uploadedImg = null;
let bgImg = null;
let shablonImg = null;

// ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸ ÑÑ†ÐµÐ½Ð¸
let scale = 1;
let offsetX = 0, offsetY = 0;
let isDragging = false;
let startX, startY;

// Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÐ²Ð°Ñ‡ Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½ÑŒ
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

// ÐœÐ°Ð»ÑŽÐ²Ð°Ð½Ð½Ñ ÑÑ†ÐµÐ½Ð¸
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);

  if (bgImg) {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
  }

  if (uploadedImg) {
    ctx.drawImage(uploadedImg, 0, 0, canvas.width, canvas.height);
  }

  if (shablonImg) {
    ctx.drawImage(shablonImg, 0, 0, canvas.width, canvas.height);
  }

  ctx.restore();
}

// Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ñ„Ð¾Ñ‚Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
document.getElementById("upload").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    uploadedImg = new Image();
    uploadedImg.onload = draw;
    uploadedImg.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// ÐœÐ°ÑÑˆÑ‚Ð°Ð±ÑƒÐ²Ð°Ð½Ð½Ñ
document.getElementById("scaleSlider").addEventListener("input", e => {
  scale = parseFloat(e.target.value);
  draw();
});

// ÐŸÐµÑ€ÐµÑ‚ÑÐ³ÑƒÐ²Ð°Ð½Ð½Ñ ÑÑ†ÐµÐ½Ð¸
canvas.addEventListener("mousedown", e => {
  isDragging = true;
  startX = e.offsetX - offsetX;
  startY = e.offsetY - offsetY;
});
canvas.addEventListener("mousemove", e => {
  if (isDragging) {
    offsetX = e.offsetX - startX;
    offsetY = e.offsetY - startY;
    draw();
  }
});
canvas.addEventListener("mouseup", () => isDragging = false);
canvas.addEventListener("mouseleave", () => isDragging = false);

// Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸
document.getElementById("downloadBtn").addEventListener("click", () => {
  const link = document.createElement("a");
  link.download = "love.jpg";
  link.href = canvas.toDataURL("image/jpeg", 0.95);
  link.click();
});

// Ð¡Ñ‚Ð°Ñ€Ñ‚: Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ñ„Ð¾Ð½Ñƒ Ñ– ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ
Promise.all([
  loadImage(URLS.bg),
  loadImage(URLS.template)
]).then(([bg, shablon]) => {
  bgImg = bg;
  shablonImg = shablon;
  draw();
});
</script>

</body>
</html>
