<!DOCTYPE html>

<html lang="uk">

<head>

<meta charset="UTF-8" />

<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>

<style>    

body { font-family: sans-serif; text-align: center; background: url(images/unamed.jpg) repeat scroll top left; }

.venwin { border-radius: 10px; display: inline-block; background-color: rgba(255, 255, 255, 0.5); padding: 20px 20px; box-sizing: border-box;}

/* –ó–º—ñ–Ω–µ–Ω–æ CSS –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞–Ω–≤–∞—Å—É –º–µ–Ω—à–∏–º, –Ω—ñ–∂ –π–æ–≥–æ —Ä–µ–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä */

canvas { 

    border: 3px solid #bbb; 

    border-radius: 6px; 

    box-shadow: 0 6px 18px rgba(0,0,0,.1); 

    display: block; 

    margin: 10px auto; 

    width: 630px; /* –í—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∏–π —Ä–æ–∑–º—ñ—Ä */

    height: 420px; /* –í—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∏–π —Ä–æ–∑–º—ñ—Ä */

  transition: transform 0.3s ease-in-out;

  transform-origin: center center;

  cursor:pointer;

  position: relative; /* –î–æ–¥–∞—î–º–æ —Ü–µ! */

  z-index: 10;

}

.preview-zoom-in:hover {
    transform: scale(1.43);
}

    

#scaleSlider { width: 420px; } /* –ê–¥–∞–ø—Ç–æ–≤–∞–Ω–æ –¥–æ —à–∏—Ä–∏–Ω–∏ –∫–∞–Ω–≤–∞—Å—É */

button { padding: 8px 12px; cursor: pointer; border-radius: 8px; }

.disabled { pointer-events: none; opacity: .5; filter: grayscale(100%); }

.gallery-container { display: flex; align-items: flex-start; justify-content: center; gap: 10px; margin-top: 10px; }

.gallery-block { display: flex; flex-direction: column; align-items: center; gap: 10px; }

.gallery-block > div { display: flex; align-items: center; justify-content: center;}

.arrow, .arow { font-size: 20px; cursor: pointer; user-select: none; padding: 3px; line-height: 1; display: flex; align-items: center; justify-content: center; }

.arrow:first-child { margin-right: -130px; }

.arrow:last-child { margin-left: -130px; }

.arow:first-child { margin-right: -60px; }

.arow:last-child { margin-left: -60px; }

.thumbnails { display: flex; gap: 10px; overflow: hidden; width: 630px; justify-content: center; }

.thumb-wrapper { position: relative; }

.thumb { width: 108px; height: 72px; object-fit: cover; cursor: pointer; box-shadow: 0 0 6px rgba(0,0,0,0.3); transition: all 0.3s ease; z-index: 1; border-radius: 10px; }

/* –î–æ–¥–∞–Ω–æ –Ω–æ–≤–∏–π —Å—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—ó/–æ–±—Ä–∞–Ω–æ—ó –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏ */

.thumb.active { border: 3px solid red; box-shadow: 0 0 10px red; }

.collage {

    position: relative;

    display: inline-block;

    margin-top: 0;

}

.gallery-container.vows .labels { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; margin-bottom: 5px; }

.gallery-container.vows .labels .label1 { grid-column: 1; font-weight: bold; margin-left: 70px; }

.gallery-container.vows .labels .label2 { grid-column: 3; font-weight: bold; }

.arrow, .arow { position: relative; z-index: 3; }

.button-row { display: flex; justify-content: center; align-items: center; gap: 10px; }


#fot { display: inline-block; cursor: pointer; border-radius: 8px; width: 108px; height: 72px; background-image: url(https://detectfraud.github.io/gallery/Para.png); background-repeat: no-repeat; background-size: contain; }

#fot:hover { mix-blend-mode: luminosity; }

#fot:active { mix-blend-mode: exclusion; }


/* –ó–º—ñ–Ω–∏ –≤ —Å—Ç–∏–ª—è—Ö imagbox */

.imagbox {

    position: absolute;

    top: 50%;

    left: 50%;

    transform: translate(-50%,-50%) scale(0.1);

    width: 825px;

    height: 510px;

    opacity: 0;

    transition: all 0.9s ease;

    z-index: 9999;

    border-radius: 12px;

    box-shadow: 0 0 25px rgba(0,0,0,0.7);

    pointer-events: none;

    background: #fff;

}

.imagbox.show {

    opacity: 1;

    transform: translate(-50%,-50%) scale(0.6);

}


.photo-block { margin-left: 100px; }

#updateBtn { margin-left: 300px; font-weight: bold; color: red; }


/* –ö–Ω–æ–ø–∫–∞ –¥–æ–Ω–∞—Ç—É */

.donate-btn {

    position: fixed;

    bottom: 20px;

    right: 20px;

    background-color: #e74c3c;

    color: white;

    border-radius: 50%;

    width: 60px;

    height: 60px;

    display: flex;

    align-items: center;

    justify-content: center;

    font-size: 28px;

    text-decoration: none;

    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);

    cursor: pointer;

    z-index: 1000;

    animation: pulse 1.5s infinite;

}


@keyframes pulse {

    0% { transform: scale(1); }

    50% { transform: scale(1.1); }

    100% { transform: scale(1); }

}


/* –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ */

@media (max-width: 768px) {

    .venwin { padding: 10px; }

    canvas { width: 95%; height: auto; }

    #scaleSlider { width: 95%; }

    .gallery-container { flex-direction: column; align-items: center; }

    .thumbnails { width: 100%; justify-content: center; }

    .arrow:first-child, .arrow:last-child { margin: 0 10px; }

    .arow:first-child, .arow:last-child { margin: 0 10px; }

    .photo-block { margin-left: 0; }

    #updateBtn { margin-left: 0; margin-top: 10px; }

    .gallery-container.vows .labels { grid-template-columns: 1fr 1fr; }

    .gallery-container.vows .labels .label1, .gallery-container.vows .labels .label2 { margin: 0; }

    .donate-btn { bottom: 10px; right: 10px; width: 50px; height: 50px; font-size: 24px; }

}

</style>

</head>

<body>


<fieldset class="venwin" style="height:auto;">

<div class="collage" id="collage">

    <canvas id="canvas" width="900" height="600" style="cursor: pointer;border:1px solid #ccc;"></canvas>

    <img id="imagePreview" class="imagbox" src="" alt="Image Preview">

</div>

<br><b style="text-align: center;">–†–æ–∑–º—ñ—Ä</b>

<br><input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1" style="cursor: pointer;">

<div class="gallery-container">

    <div class="gallery-block" id="vowsi">

        <b>–§–æ–Ω</b><br /><br />

        <div>

            <span class="arrow" onclick="prevSlide()">&#10094;</span>

            <div class="thumbnails" id="thumbs"></div>

            <span class="arrow" onclick="nextSlide()">&#10095;</span>

        </div>

    </div>

    <div class="gallery-block photo-block">

        <b>–í–∞—à–µ —Ñ–æ—Ç–æ</b><br /><br />

        <div>

            <label id="fot" class="disabled" title="–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö"></label>

        </div>

    </div>

</div>


<div class="gallery-container vows" id="vowse" style="display:none;">

    <div class="gallery-block">

        <div class="labels">

            <span class="label1">–ù–∞–¥–ø–∏—Å</span>

            <span class="label2">–ö–ª—è—Ç–≤–∞ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö</span>

        </div>

        <div class="gallery-row">

            <span class="arow" onclick="prevVow()">&#10094;</span>

            <div class="thumbnails" id="thumbsVows"></div>

            <span class="arow" onclick="nextVow()">&#10095;</span>

        </div>

    </div>

</div>


<p class="button-row">

    <button id="undoBtn" type="button">‚ü≤ Undo</button>

    <button id="previewBtn" type="button" class="disabled">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>

    <button id="downloadBtn" type="button" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>

    <button id="updateBtn" type="button">UPDATE</button>

</p><br>

</fieldset>

<a href="https://example.com/donate" class="donate-btn" target="_blank" title="–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç">‚ù§Ô∏è</a>

<input type="file" id="bgLoader" style="display:none">

<input type="file" id="loveLoader" style="display:none">

<script>

/* === Collage JS === */


// –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ DOM-–µ–ª–µ–º–µ–Ω—Ç–∏

const canvas = document.getElementById('canvas');

const ctx = canvas.getContext('2d');

const thumbs = document.getElementById('thumbs');

const thumbsVows = document.getElementById('thumbsVows');

const loveLoader = document.getElementById('loveLoader');

const scaleSlider = document.getElementById('scaleSlider');

const undoBtn = document.getElementById('undoBtn');

const previewBtn = document.getElementById('previewBtn');

const downloadBtn = document.getElementById('downloadBtn');

const bgLoader = document.getElementById('bgLoader');

const collage = document.getElementById('collage');

const vowse = document.getElementById('vowse');

const vowsi = document.getElementById('vowsi');

const photoBlock = document.querySelector('.photo-block');

const loveStoneName = "LoveStones";

const DONATE_URL = "https://example.com/donate";

const imagePreview = document.getElementById('imagePreview'); // –ù–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç –ø—Ä–µ–≤'—é


// --- –î–∞–Ω—ñ —Ç–∞ –≥–∞–ª–µ—Ä–µ—ó ---

const url = "https://detectfraud.github.io/gallery/";

const images = [ "nature(1)","nature(2)","nature(3)","nature(4)","nature(5)",

"nature(6)","nature(7)","nature(8)","nature(9)","Fon" ];

const fullImages = images.map(name => url + name + ".jpeg");

let startIndex = 0;


const vows = ["Eternity","Fidelity","Joy","Love","Strength","Tenderness","Trust","Unity","Heart","Hearts"];

const fullVows = vows.map(name => url + name + ".png");

let vowIndex = 0;


const lovestoneImages = ["LoveStones"];

const fullLovestones = lovestoneImages.map(name => url + name + ".png");

let lovestoneIndex = 0;


// –ó–±–µ—Ä—ñ–≥–∞—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø–æ—Ç–æ—á–Ω—É –∞–∫—Ç–∏–≤–Ω—É –º—ñ–Ω—ñ–∞—Ç—é—Ä—É

let activeThumb = null;


// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—ó –º—ñ–Ω—ñ–∞—Ç—é—Ä–∏

function setActiveThumb(thumbElement) {

    if (activeThumb) {

        activeThumb.classList.remove('active');

    }

    thumbElement.classList.add('active');

    activeThumb = thumbElement;

}


// –§—É–Ω–∫—Ü—ñ—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –ø—Ä–µ–≤'—é –¥–ª—è —Ñ–æ–Ω—ñ–≤

function renderThumbnails() {

    thumbs.innerHTML = "";

    activeThumb = null; // –û—á–∏—â—É—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å–ª–∞–π–¥—É

    fullImages.slice(startIndex, startIndex + 3).forEach(src => createThumb(src, thumbs, 'bg'));

}


// –§—É–Ω–∫—Ü—ñ—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –ø—Ä–µ–≤'—é –¥–ª—è –∫–ª—è—Ç–≤ —Ç–∞ –Ω–∞–¥–ø–∏—Å—ñ–≤

function renderVows() {

    thumbsVows.innerHTML = "";

    activeThumb = null; // –û—á–∏—â—É—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å–ª–∞–π–¥—É

    // –†–µ–Ω–¥–µ—Ä–∏–º–æ –Ω–∞–¥–ø–∏—Å –æ–∫—Ä–µ–º–æ

    fullLovestones.slice(lovestoneIndex, lovestoneIndex + 1).forEach(src => createThumb(src, thumbsVows, 'lovestone'));

    // –†–µ–Ω–¥–µ—Ä–∏–º–æ –∫–ª—è—Ç–≤–∏

    fullVows.slice(vowIndex, vowIndex + 3).forEach(src => createThumb(src, thumbsVows, 'vow'));

}


// –§—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–µ–≤'—é-–∫–∞—Ä—Ç–∏–Ω–∫–∏

function createThumb(src, container, key) {

    const wrapper = document.createElement("div");

    wrapper.className = "thumb-wrapper";

    const imgName = src.split("/").pop().split(".")[0];

    const thumb = document.createElement("img");

    thumb.className = "thumb";

    thumb.src = src;


    // –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É

    let timer;

    wrapper.addEventListener('mouseenter', () => {

        timer = setTimeout(() => {

            imagePreview.src = src; // –û–Ω–æ–≤–ª—é—î–º–æ src —î–¥–∏–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–µ–≤'—é

            imagePreview.classList.add('show');

        }, 700);

    });

    wrapper.addEventListener('mouseleave', () => {

        clearTimeout(timer);

        imagePreview.classList.remove('show');

    });


    if (imgName === "Fon") {

        thumb.title = "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤—ñ–π —Ñ–æ–Ω";

        thumb.onclick = () => {

            bgLoader.click();

            imagePreview.classList.remove('show'); // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø—Ä–µ–≤'—é

        };

    } else {

        thumb.onclick = () => {

            handleFileFromGallery(src, key);

            if (key === 'bg') {

                setActiveThumb(thumb);

            }

        };

    }


    wrapper.appendChild(thumb);

    container.appendChild(wrapper);

}


// –§—É–Ω–∫—Ü—ñ—ó –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≥–∞–ª–µ—Ä–µ–π

function prevSlide(){

    startIndex=(startIndex-3+fullImages.length)%fullImages.length;

    renderThumbnails();

}

function nextSlide(){

    startIndex=(startIndex+3)%fullImages.length;

    renderThumbnails();

}

function prevVow(){ vowIndex=(vowIndex-3+fullVows.length)%fullVows.length; renderVows(); }

function nextVow(){ vowIndex=(vowIndex+3)%fullVows.length; renderVows(); }


// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ –≥–∞–ª–µ—Ä–µ—ó –Ω–∞ Canvas

function handleFileFromGallery(src, key){

    imagePreview.classList.remove('show'); // –í–∏–¥–∞–ª—è—î–º–æ –∫–ª–∞—Å –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ø—Ä–µ–≤'—é

    const img = new Image();

    img.crossOrigin = "anonymous";

    img.onload = () => {

        layers[key].img = img;

        layers[key].src = src;


        if (key === 'vow') {

            layers[key].scale = 0.5;

            layers[key].x = (img.width * layers[key].scale / 2) + 14.28; // –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–æ

            layers[key].y = canvas.height - (img.height * layers[key].scale / 2) - 14.28; // –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–æ

        } else if (key === 'lovestone') {

            layers[key].scale = 0.5;

            layers[key].x = canvas.width / 2;

            layers[key].y = canvas.height / 2;

        } else {

            layers[key].x = canvas.width / 2;

            layers[key].y = canvas.height / 2;

            layers[key].scale = 1;

        }

        activeLayer = key;

        if (activeLayer) {

            scaleSlider.value = layers[activeLayer].scale;

        }

        scaleSlider.disabled = false;

        scaleSlider.classList.remove('disabled');

        pushHistory();

        drawAll();


        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å—Ç–∞–Ω–æ–º –∫–Ω–æ–ø–æ–∫

        if (key === 'bg') {

            document.getElementById('fot').classList.remove('disabled');

        }

        if (key === 'love' || key === 'lovestone') {

            document.getElementById('previewBtn').classList.remove('disabled');

        }


        previewBtn.style.display = 'inline-block';

        downloadBtn.style.display = 'none';

    };

    img.src = src;

}


// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ/—Ñ–æ–Ω—ñ–≤ –∑ —Ñ–∞–π–ª—É

function handleFileLoad(file,key){

    if(!file) return;

    const reader=new FileReader();

    reader.onload=e=>{

        const data=e.target.result;

        const img=new Image();

        img.onload=()=>{

            layers[key].img=img;

            layers[key].src=data;

            layers[key].x = canvas.width / 2;

            layers[key].y = canvas.height / 2;

            layers[key].scale = 1;

            activeLayer = key;

            if (activeLayer) {

                scaleSlider.value = layers[activeLayer].scale;

            }

            scaleSlider.disabled = false;

            scaleSlider.classList.remove('disabled');

            pushHistory();

            drawAll();

            // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å—Ç–∞–Ω–æ–º –∫–Ω–æ–ø–æ–∫

            if (key === 'bg') {

                document.getElementById('fot').classList.remove('disabled');

            }

            if (key === 'love') {

                document.getElementById('previewBtn').classList.remove('disabled');

            }

        };

        img.src=data;

    };

    reader.readAsDataURL(file);

}


// –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤

bgLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'bg'));

loveLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'love'));

document.getElementById("fot").onclick=()=>loveLoader.click();


// --- –®–∞—Ä–∏, –º–∞—Å–∫–∞ —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—è ---

const template=new Image(); template.src='images/composit.png';

// –ü–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É –∫–∞–Ω–≤–∞—Å—É 900x600

const HOLE_OFFSET_X=6, HOLE_OFFSET_Y=-115, HOLE_RADIUS=98;

let mask={cx:canvas.width/2+HOLE_OFFSET_X, cy:canvas.height/2+HOLE_OFFSET_Y, r:HOLE_RADIUS};


// –ù–æ–≤—ñ –ø–æ—á–∞—Ç–∫–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è —à–∞—Ä—ñ–≤

let layers={

    bg:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},

    love:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},

    vow:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},

    lovestone:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1}

};

let activeLayer=null, previewMode=false, bgHoleActive=true;


const history=[]; const MAX_HISTORY=20;

function makeSnapshot(){ return { bg:{...layers.bg}, love:{...layers.love}, loveScale: scaleSlider.value, vow:{...layers.vow}, lovestone:{...layers.lovestone}, previewMode, activeLayer, bgHoleActive }; }

function pushHistory(){ history.push(makeSnapshot()); if(history.length>MAX_HISTORY) history.shift(); }

function applySnapshot(s){

    previewMode=!!s.previewMode; activeLayer=s.activeLayer||null; bgHoleActive=!!s.bgHoleActive;

    

    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫

    if (s.bg.img) {

        document.getElementById('fot').classList.remove('disabled');

    } else {

        document.getElementById('fot').classList.add('disabled');

    }

    if (s.love.img) {

        document.getElementById('previewBtn').classList.remove('disabled');

    } else {

        document.getElementById('previewBtn').classList.add('disabled');

    }


    ['bg','love','vow','lovestone'].forEach(key=>{

        const v=s[key];

        if(v && v.src){

            const img=new Image();

            img.onload=()=>{ layers[key].img=img; layers[key].src=v.src; layers[key].x=v.x; layers[key].y=v.y; layers[key].scale=v.scale; drawAll(); };

            img.src=v.src;

        } else {

            layers[key].img=null; layers[key].src=null;

            layers[key].x=v? v.x: canvas.width/2;

            layers[key].y=v? v.y: canvas.height/2;

            layers[key].scale=v? v.scale:1;

        }

    });

    toggleButtons();

}


// --- –§—É–Ω–∫—Ü—ñ—ó –º–∞–ª—é–≤–∞–Ω–Ω—è –Ω–∞ Canvas ---

// –í–∏–¥–∞–ª–µ–Ω–æ scaleFactor, –æ—Å–∫—ñ–ª—å–∫–∏ –º–∏ –±—ñ–ª—å—à–µ –Ω–µ –º–∞—Å—à—Ç–∞–±—É—î–º–æ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

function drawLayerTo(ctxTarget, layer){

    if(!layer||!layer.img) return;

    const w = layer.img.width * layer.scale;

    const h = layer.img.height * layer.scale;

    const x = layer.x;

    const y = layer.y;

    ctxTarget.drawImage(layer.img, x - w/2, y - h/2, w, h);

}

function drawLove(ctxTarget, clip=false){

    const L=layers.love;

    if(!L||!L.img) return;

    const w = L.img.width * L.scale;

    const h = L.img.height * L.scale;

    const x = L.x;

    const y = L.y;

    ctxTarget.save();

    if(clip && mask.r>0){

        ctxTarget.beginPath();

        ctxTarget.arc(mask.cx, mask.cy, mask.r, 0, Math.PI * 2);

        ctxTarget.clip();

    }

    ctxTarget.drawImage(L.img, x - w/2, y - h/2, w, h);

    ctxTarget.restore();

}

function drawBgWithHole(ctxTarget){

    if(!layers.bg.img) return;

    if(!bgHoleActive||mask.r<=0){ drawLayerTo(ctxTarget,layers.bg); return; }

    const off = document.createElement('canvas');

    off.width = canvas.width;

    off.height = canvas.height;

    const octx = off.getContext('2d');

    drawLayerTo(octx, layers.bg);

    octx.globalCompositeOperation = 'destination-out';

    octx.beginPath();

    octx.arc(mask.cx, mask.cy, mask.r, 0, Math.PI * 2);

    octx.fill();

    octx.globalCompositeOperation = 'source-over';

    ctxTarget.drawImage(off, 0, 0);

}

function drawAll(){

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawBgWithHole(ctx);

    drawLove(ctx, previewMode);

    if(template.complete) {

        ctx.drawImage(template, 0, 0, canvas.width, canvas.height);

    }

    drawLayerTo(ctx, layers.vow);

    drawLayerTo(ctx, layers.lovestone);

}


// --- –ö–Ω–æ–ø–∫–∏ —Ç–∞ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤ ---

function toggleButtons(){
    if(previewMode){
        previewBtn.style.display = 'none';
        downloadBtn.style.display = 'inline-block';
        if (vowsi) vowsi.style.display = 'none';
        if (photoBlock) photoBlock.style.display = 'none';
        if (vowse) vowse.style.display = 'inline-block';
        canvas.classList.add('preview-zoom-in'); // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å
        activeLayer = null;
    } else {
        previewBtn.style.display = 'inline-block';
        downloadBtn.style.display = 'none';
        if (vowsi) vowsi.style.display = 'inline-block';
        if (photoBlock) photoBlock.style.display = 'inline-block';
        if (vowse) vowse.style.display = 'none';
        canvas.classList.remove('preview-zoom-in'); // –í–∏–¥–∞–ª—è—î–º–æ –∫–ª–∞—Å
    }
}


// –û–±—Ä–æ–±–∫–∞ –ø–æ–≤–∑—É–Ω–∫–∞ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è

scaleSlider.addEventListener('input',()=>{

    if(!activeLayer) return;

    layers[activeLayer].scale=parseFloat(scaleSlider.value);

    drawAll();

});


// --- Drag & Touch (–ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–æ–∫) ---
let dragging=false, dragStartX=0, dragStartY=0;
canvas.addEventListener('mousedown',e=>{
    if(previewMode || !activeLayer) return; // –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è —É —Ä–µ–∂–∏–º—ñ –ø–µ—Ä–µ–≥–ª—è–¥—É
    dragging=true;
    dragStartX=e.offsetX-layers[activeLayer].x;
    dragStartY=e.offsetY-layers[activeLayer].y;
});
canvas.addEventListener('mousemove',e=>{
    if(!dragging || previewMode || !activeLayer) return; // –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è —É —Ä–µ–∂–∏–º—ñ –ø–µ—Ä–µ–≥–ª—è–¥—É
    layers[activeLayer].x=e.offsetX-dragStartX;
    layers[activeLayer].y=e.offsetY-dragStartY;
    drawAll();
});
function stopDrag(){
    if(dragging){ dragging=false; pushHistory(); }
}
canvas.addEventListener('mouseup',stopDrag);
canvas.addEventListener('mouseleave',stopDrag);
canvas.addEventListener('touchstart',e=>{
    if(previewMode || !activeLayer) return; // –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è —É —Ä–µ–∂–∏–º—ñ –ø–µ—Ä–µ–≥–ª—è–¥—É
    const t=e.touches[0],rect=canvas.getBoundingClientRect();
    dragging=true;
    dragStartX=(t.clientX-rect.left) * (canvas.width/rect.width) - layers[activeLayer].x;
    dragStartY=(t.clientY-rect.top) * (canvas.height/rect.height) - layers[activeLayer].y;
    e.preventDefault();
});
canvas.addEventListener('touchmove',e=>{
    if(!dragging || previewMode || !activeLayer) return; // –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è —É —Ä–µ–∂–∏–º—ñ –ø–µ—Ä–µ–≥–ª—è–¥—É
    const t=e.touches[0],rect=canvas.getBoundingClientRect();
    layers[activeLayer].x=(t.clientX-rect.left) * (canvas.width/rect.width) - dragStartX;
    layers[activeLayer].y=(t.clientY-rect.top) * (canvas.height/rect.height) - dragStartY;
    drawAll();
    e.preventDefault();
});
canvas.addEventListener('touchend',stopDrag);


// --- Undo / Preview / Download ---

undoBtn.addEventListener('click',()=>{

    if(history.length<=1) return;

    history.pop();

    applySnapshot(history[history.length-1]);

});

previewBtn.addEventListener('click',()=>{

    previewMode=true;

    scaleSlider.disabled = true;

    scaleSlider.classList.add('disabled');

    pushHistory();

    toggleButtons();

    drawAll();

});

downloadBtn.addEventListener('click',()=>{

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–∞–Ω–≤–∞—Å—É

    const link=document.createElement('a');

    link.download='collage.jpg';

    link.href=canvas.toDataURL('image/jpeg');

    link.click();

});

document.getElementById('updateBtn').addEventListener('click', function () {

    const confirmUpdate = confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É? –£—Å—ñ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω—ñ –∑–º—ñ–Ω–∏ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.");

    if (confirmUpdate) {

        const url = window.location.href.split('?')[0];

        window.location.href = url + '?_=' + new Date().getTime();

    }

});


// –í–∏–º–∫–Ω–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é —Ç–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è

function disableContextMenu() {

    return false;

}

document.oncontextmenu = disableContextMenu;

document.onselectstart = disableContextMenu;

document.ondragstart = disableContextMenu;


// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è

template.onload = () => { drawAll(); };

renderThumbnails();

renderVows();

applySnapshot(history[0] || makeSnapshot());

</script>

</body>

</html> 
