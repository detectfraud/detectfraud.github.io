<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</title>
<style>
body { text-align:center; font-family:sans-serif; }
.venwin {
  background: #fff;
  border-radius:10px;
  padding:10px;
  display:inline-block;
}
canvas {
  border:3px solid #bbb;
  border-radius:3%;
  box-shadow:0 6px 18px rgba(0,0,0,.1);
  display:block;
  margin:10px auto;
}
</style>
</head>
<body>

<fieldset class="venwin" style="height:auto;">
  <center>
    <span style="color:#990000;font-size:x-large;">–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</span><br><br>
    <canvas id="canvas" width="900" height="600" style="border:1px solid #ccc;"></canvas>
    <br><br>
    <label>–§–æ–Ω:&nbsp;&nbsp;<input type="file" id="bgLoader" accept="image/*"></label>
    <label>–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö:&nbsp;&nbsp;<input type="file" id="loveLoader" accept="image/*"></label>
    <br><br>
    <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1" style="width:400px;">
    <br><br>
    <button id="undoBtn">‚ü≤ Undo</button>
    <button id="previewBtn">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
    <button id="downloadBtn" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  </center>
</fieldset>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let template = new Image();
template.src = "images/LoveStone.png"; // PNG-—à–∞–±–ª–æ–Ω –∑ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—é

let layers = {
  bg: { img: null, x: 0, y: 0, scale: 1 },
  love: { img: null, x: 0, y: 0, scale: 1 }
};

let activeLayer = null;
let isDragging = false;
let dragOffsetX = 0, dragOffsetY = 0;
let previewMode = false;

// —ñ—Å—Ç–æ—Ä—ñ—è –¥–ª—è Undo
let history = [];

function saveState() {
  const state = {
    layers: JSON.parse(JSON.stringify(layers)),
    activeLayer,
    previewMode
  };
  history.push(state);
}

function restoreState(state) {
  layers = JSON.parse(JSON.stringify(state.layers));
  activeLayer = state.activeLayer;
  previewMode = state.previewMode;
  toggleButtons();
  drawAll();
}

// --- –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ---
document.getElementById("bgLoader").addEventListener("change", e => {
  loadImage(e.target.files[0], img => {
    layers.bg.img = img;
    layers.bg.x = canvas.width/2;
    layers.bg.y = canvas.height/2;
    layers.bg.scale = 1;
    activeLayer = "bg";
    document.getElementById("scaleSlider").value = 1;
    saveState();
    drawAll();
  });
});

document.getElementById("loveLoader").addEventListener("change", e => {
  loadImage(e.target.files[0], img => {
    layers.love.img = img;
    layers.love.x = canvas.width/2;
    layers.love.y = canvas.height/2;
    layers.love.scale = 1;
    activeLayer = "love";
    document.getElementById("scaleSlider").value = 1;
    saveState();
    drawAll();
  });
});

function loadImage(file, callback) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => callback(img);
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// --- —Å–ª–∞–π–¥–µ—Ä ---
document.getElementById("scaleSlider").addEventListener("input", e => {
  if (!activeLayer) return;
  layers[activeLayer].scale = parseFloat(e.target.value);
  saveState();
  drawAll();
});

// --- drag ---
canvas.addEventListener("mousedown", e => {
  if (!activeLayer) return;
  isDragging = true;
  dragOffsetX = e.offsetX - layers[activeLayer].x;
  dragOffsetY = e.offsetY - layers[activeLayer].y;
});
canvas.addEventListener("mousemove", e => {
  if (!isDragging || !activeLayer) return;
  layers[activeLayer].x = e.offsetX - dragOffsetX;
  layers[activeLayer].y = e.offsetY - dragOffsetY;
  drawAll();
});
canvas.addEventListener("mouseup", () => {
  if (isDragging) {
    isDragging = false;
    saveState();
  }
});

// --- Undo ---
document.getElementById("undoBtn").addEventListener("click", () => {
  if (history.length > 1) {
    history.pop(); 
    const prev = history[history.length-1];
    restoreState(prev);
  }
});

// --- Preview ---
document.getElementById("previewBtn").addEventListener("click", () => {
  previewMode = true;
  saveState();
  toggleButtons();
  drawAll();
});

function toggleButtons() {
  document.getElementById("previewBtn").style.display = previewMode ? "none" : "inline-block";
  document.getElementById("downloadBtn").style.display = previewMode ? "inline-block" : "none";
}

// --- Download ---
document.getElementById("downloadBtn").addEventListener("click", () => {
  const link = document.createElement('a');
  link.download = 'composition.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});

// --- –º–∞–ª—é–≤–∞–Ω–Ω—è ---
function drawAll() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (previewMode) {
    // –º–∞—Å–∫—É–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω–æ–º
    ctx.save();
    ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
    ctx.globalCompositeOperation = "source-in";
    if (layers.bg.img) drawLayer(layers.bg);
    if (layers.love.img) drawLayer(layers.love);
    ctx.restore();
    ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
  } else {
    if (layers.bg.img) drawLayer(layers.bg);
    if (layers.love.img) drawLayer(layers.love);
    ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
  }
}

function drawLayer(layer) {
  const w = layer.img.width * layer.scale;
  const h = layer.img.height * layer.scale;
  ctx.drawImage(layer.img, layer.x - w/2, layer.y - h/2, w, h);
}

saveState();
drawAll();
</script>
</body>
</html>
