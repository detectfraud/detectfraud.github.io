<!-- Collage (27.08.25) v2.1 ‚Äî –¥–æ–¥–∞–Ω–æ label1/label2 -->
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<style>
/* —Å—Ç–∏–ª—ñ —Ç—ñ –∂ */
body { font-family: sans-serif; text-align:center; background:url(https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjghIwEmgtr9VAIzGM4eS8BdLA1nptupwYDch46JvrMH9AILVqnNpUX_vxUtQe2Kr-eNLgXcUu_dfNCc7P45vPblF37xpoN8dbLsm9VHiMKmYf58ixmJeQHTY4R4hvGXj0nC7SqiD_2UWRGvIDgUrvZqoVqq8qT61yJB846igsv4ceY7Q/s1600/fon.png) repeat scroll top left; }
canvas { border:3px solid #bbb; border-radius:6px; display:block; margin:10px auto; }
#scaleSlider { width:420px;}
button { padding:8px 12px; cursor:pointer; border-radius:8px; }
.disabled { pointer-events:none; opacity:.5; filter:grayscale(100%); }
</style>
</head>
<body>

<fieldset class="venwin">
  <div class="collage" id="collage">
    <canvas id="canvas" width="900" height="600"></canvas>
  </div>
  <br><input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1"><br><br>

  <button id="undoBtn">‚ü≤ Undo</button>
  <button id="previewBtn">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
  <button id="downloadBtn" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
</fieldset>

<!-- –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á—ñ -->
<input type="file" id="bgLoader" style="display:none">
<input type="file" id="loveLoader" style="display:none">
<input type="file" id="label1Loader" style="display:none">
<input type="file" id="label2Loader" style="display:none">

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const scaleSlider = document.getElementById('scaleSlider');
const undoBtn = document.getElementById('undoBtn');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');
const bgLoader = document.getElementById('bgLoader');
const loveLoader = document.getElementById('loveLoader');
const label1Loader = document.getElementById('label1Loader');
const label2Loader = document.getElementById('label2Loader');

const template=new Image(); template.src='images/composit.png';
const mask={cx:canvas.width/2+6, cy:canvas.height/2-115, r:98};

/* === –î–û–î–ê–ù–û label1/label2 === */
let layers={
  bg:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},
  love:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},
  label1:{img:null,src:null,x:canvas.width/2,y:canvas.height-80,scale:1},
  label2:{img:null,src:null,x:canvas.width/2,y:canvas.height-40,scale:1}
};
let activeLayer=null, previewMode=false, bgHoleActive=true;
const history=[]; const MAX_HISTORY=20;

/* === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è === */
function handleFileLoad(file,key){
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      layers[key].img=img; layers[key].src=e.target.result;
      layers[key].x=canvas.width/2; layers[key].y=canvas.height/2;
      layers[key].scale=1; activeLayer=key;
      scaleSlider.value=1;
      pushHistory(); drawAll();
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
bgLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'bg'));
loveLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'love'));
label1Loader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'label1'));
label2Loader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'label2'));

/* === Undo / Snapshots === */
function makeSnapshot(){ return {bg:{...layers.bg}, love:{...layers.love}, label1:{...layers.label1}, label2:{...layers.label2}, previewMode, activeLayer, bgHoleActive}; }
function applySnapshot(s){
  if(!s) return;
  previewMode=!!s.previewMode; activeLayer=s.activeLayer||null; bgHoleActive=!!s.bgHoleActive;
  ['bg','love','label1','label2'].forEach(k=>{
    const v=s[k];
    if(v && v.src){
      const img=new Image();
      img.onload=()=>{ layers[k].img=img; layers[k].src=v.src; layers[k].x=v.x; layers[k].y=v.y; layers[k].scale=v.scale; drawAll(); };
      img.src=v.src;
    } else { layers[k].img=null; layers[k].src=null; layers[k].x=v?v.x:canvas.width/2; layers[k].y=v?v.y:canvas.height/2; layers[k].scale=v?v.scale:1; }
  });
  toggleButtons();
}
function pushHistory(){ history.push(makeSnapshot()); if(history.length>MAX_HISTORY) history.shift(); }
pushHistory();

/* === –ú–∞–ª—é–≤–∞–Ω–Ω—è === */
function drawLayerTo(ctx,l){ if(!l||!l.img) return; const w=l.img.width*l.scale,h=l.img.height*l.scale; ctx.drawImage(l.img,l.x-w/2,l.y-h/2,w,h); }
function drawLove(ctx,clip=false){ const L=layers.love;if(!L.img) return; const w=L.img.width*L.scale,h=L.img.height*L.scale; ctx.save(); if(clip){ ctx.beginPath(); ctx.arc(mask.cx,mask.cy,mask.r,0,Math.PI*2); ctx.clip(); } ctx.drawImage(L.img,L.x-w/2,L.y-h/2,w,h); ctx.restore(); }
function drawBgWithHole(ctx){ if(!layers.bg.img) return; if(!bgHoleActive){drawLayerTo(ctx,layers.bg);return;} const off=document.createElement('canvas'); off.width=canvas.width; off.height=canvas.height; const octx=off.getContext('2d'); drawLayerTo(octx,layers.bg); octx.globalCompositeOperation='destination-out'; octx.beginPath(); octx.arc(mask.cx,mask.cy,mask.r,0,Math.PI*2); octx.fill(); ctx.drawImage(off,0,0); }
function drawAll(){ ctx.clearRect(0,0,canvas.width,canvas.height); if(!previewMode){drawBgWithHole(ctx);drawLove(ctx,false);} else {drawLove(ctx,true);drawBgWithHole(ctx);} if(layers.label1.img) drawLayerTo(ctx,layers.label1); if(layers.label2.img) drawLayerTo(ctx,layers.label2); if(template.complete) ctx.drawImage(template,0,0,canvas.width,canvas.height); }

/* === UI === */
function toggleButtons(){ previewBtn.style.display=previewMode?'none':'inline-block'; downloadBtn.style.display=previewMode?'inline-block':'none'; }
scaleSlider.addEventListener('input',()=>{ if(!activeLayer) return; layers[activeLayer].scale=parseFloat(scaleSlider.value); drawAll(); });
undoBtn.addEventListener('click',()=>{ if(history.length<=1) return; history.pop(); applySnapshot(history[history.length-1]); });
previewBtn.addEventListener('click',()=>{ previewMode=true; pushHistory(); toggleButtons(); drawAll(); });
downloadBtn.addEventListener('click',()=>{ const link=document.createElement('a'); link.download='composition.png'; link.href=canvas.toDataURL('image/png'); link.click(); });

template.onload=()=>drawAll();
applySnapshot(history[0]);
</script>
</body>
</html>
