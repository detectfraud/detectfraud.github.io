<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</title>
<style>
body { text-align:center; font-family:sans-serif; }
.venwin {
  background: #fff;
  border-radius:10px;
  padding:10px;
  display:inline-block;
}
canvas {
  border:3px solid #bbb;
  border-radius:3%;
  box-shadow:0 6px 18px rgba(0,0,0,.1);
  display:block;
  margin:10px auto;
}
</style>
</head>
<body>

<fieldset class="venwin" style="height:auto;">
  <br>
  <center>
    <canvas id="canvas" width="800" height="600" style="border:1px solid #ccc;"></canvas>
    <br><br>

    <input type="file" id="upload" accept="image/*"><br><br>

    –ú–∞—Å—à—Ç–∞–±:
    <input type="range" id="scaleSlider" min="0.5" max="2" value="1" step="0.01">

    <button id="downloadBtn">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  </center>
</fieldset>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const URLS = {
  shablon:  "images/shablon.png",
  template: "images/LoveStone.png",
  bg:       "images/priroda.jpg"
};

let uploadedImg = null;
let bgImg = null;
let shablonImg = null;

// –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å—Ü–µ–Ω–∏
let scale = 1;
let offsetX = 0, offsetY = 0;
let isDragging = false;
let startX, startY;

// –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á –∑–æ–±—Ä–∞–∂–µ–Ω—å
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

// –ú–∞–ª—é–≤–∞–Ω–Ω—è —Å—Ü–µ–Ω–∏
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);

  if (bgImg) {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
  }

  if (uploadedImg) {
    ctx.drawImage(uploadedImg, 0, 0, canvas.width, canvas.height);
  }

  if (shablonImg) {
    ctx.drawImage(shablonImg, 0, 0, canvas.width, canvas.height);
  }

  ctx.restore();
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
document.getElementById("upload").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    uploadedImg = new Image();
    uploadedImg.onload = draw;
    uploadedImg.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è
document.getElementById("scaleSlider").addEventListener("input", e => {
  scale = parseFloat(e.target.value);
  draw();
});

// –ü–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è —Å—Ü–µ–Ω–∏
canvas.addEventListener("mousedown", e => {
  isDragging = true;
  startX = e.offsetX - offsetX;
  startY = e.offsetY - offsetY;
});
canvas.addEventListener("mousemove", e => {
  if (isDragging) {
    offsetX = e.offsetX - startX;
    offsetY = e.offsetY - startY;
    draw();
  }
});
canvas.addEventListener("mouseup", () => isDragging = false);
canvas.addEventListener("mouseleave", () => isDragging = false);

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
document.getElementById("downloadBtn").addEventListener("click", () => {
  const link = document.createElement("a");
  link.download = "love.jpg";
  link.href = canvas.toDataURL("image/jpeg", 0.95);
  link.click();
});

// –°—Ç–∞—Ä—Ç: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ–Ω—É —ñ —à–∞–±–ª–æ–Ω—É
Promise.all([
  loadImage(URLS.bg),
  loadImage(URLS.template)
]).then(([bg, shablon]) => {
  bgImg = bg;
  shablonImg = shablon;
  draw();
});
</script>

</body>
</html>
