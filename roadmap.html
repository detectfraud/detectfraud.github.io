<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<style>
  body { text-align:center; font-family:sans-serif; }
  .venwin { background: #fff; border-radius:10px; padding:10px; display:inline-block; }
  canvas { border:3px solid #bbb; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:block; margin:10px auto; }
  #controls{ margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  #scaleSlider{ width:420px; }
  button{ padding:8px 12px; }
.disabled {
  pointer-events: none;        /* –±–ª–æ–∫—É—î –∫–ª—ñ–∫–∏/—Ç–∞—á */
  opacity: 0.5;                /* —Ä–æ–±–∏—Ç—å –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–º */
  filter: grayscale(100%);     /* —á–æ—Ä–Ω–æ-–±—ñ–ª–∏–π */
}
</style>
</head>
<body>

<fieldset class="venwin" style="height:auto;">
  <center>
    <span style="color:#990000;font-size:x-large;">–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</span><br><br>
    <canvas id="canvas" width="900" height="600" style="border:1px solid #ccc;"></canvas>

    <div id="controls">
      <label>–§–æ–Ω: <input type="file" id="bgLoader" accept="image/*"></label>
      <label>–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö: <input type="file" id="loveLoader" accept="image/*"></label>
      <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1">
      <button id="undoBtn">‚ü≤ Undo</button>
      <button id="previewBtn">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
      <button id="downloadBtn" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    </div>
  </center>
</fieldset>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const bgLoader = document.getElementById('bgLoader');
const loveLoader = document.getElementById('loveLoader');
const scaleSlider = document.getElementById('scaleSlider');
const undoBtn = document.getElementById('undoBtn');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');
let mask = { cx: 0, cy: 0, r: 0 };
let bgHoleActive = false;              // –∫–æ–ª–∏ true ‚Äî —É —Ñ–æ–Ω—ñ –ø—Ä–æ–±–∏–≤–∞—î–º–æ –∫—Ä—É–≥–ª—É –¥—ñ—Ä–∫—É
let dragging = false, dragStartX = 0, dragStartY = 0; // —è–∫—â–æ –¥–µ—Å—å –∑–Ω–∏–∫–ª–∏ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ

// —à–∞–±–ª–æ–Ω (–ø–æ–≤–µ—Ä—Ö)
const template = new Image();
template.src = 'images/LoveStone.png';

// –º–æ–¥–µ–ª—å —à–∞—Ä—ñ–≤: –∑–±–µ—Ä—ñ–≥–∞—î–º–æ img (Image) —ñ dataURL —É src –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó
let layers = {
  bg: { img: null, src: null, x: canvas.width/2, y: canvas.height/2, scale: 1 },
  love: { img: null, src: null, x: canvas.width/2, y: canvas.height/2, scale: 1 }
};

let activeLayer = null; // 'bg' –∞–±–æ 'love'
let previewMode = false;

// —ñ—Å—Ç–æ—Ä—ñ—è: –º–∞—Å–∏–≤ —Å–Ω—ç–ø—à–æ—Ç—ñ–≤ { bg:{src,x,y,scale}, love:{...}, previewMode, activeLayer }
const history = [];
const MAX_HISTORY = 20;

function makeSnapshot(){
  return {
    bg: { src: layers.bg.src, x: layers.bg.x, y: layers.bg.y, scale: layers.bg.scale },
    love: { src: layers.love.src, x: layers.love.x, y: layers.love.y, scale: layers.love.scale },
    previewMode: previewMode,
    activeLayer: activeLayer,
    bgHoleActive: bgHoleActive
  };
}


function pushHistory(){
  history.push(makeSnapshot());
  if(history.length > MAX_HISTORY) history.shift();
}

function applySnapshot(snapshot){
  // –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –¥–∂–µ—Ä–µ–ª–∞ —ñ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ layers; –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ Promise, –∫–æ–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è
  previewMode = !!snapshot.previewMode;
  activeLayer = snapshot.activeLayer || null;
bgHoleActive = !!snapshot.bgHoleActive;
  const jobs = [];

  ['bg','love'].forEach(key => {
    const s = snapshot[key];
    if(s && s.src){
      // –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É
      const img = new Image();
      const p = new Promise((res) => {
        img.onload = () => {
          layers[key].img = img;
          layers[key].src = s.src;
          layers[key].x = s.x;
          layers[key].y = s.y;
          layers[key].scale = s.scale;
          res();
        };
        img.onerror = () => {
          layers[key].img = null;
          layers[key].src = null;
          res();
        };
      });
      img.src = s.src;
      jobs.push(p);
    } else {
      // –Ω–µ–º–∞—î –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ —Å–Ω—ç–ø—à–æ—Ç—ñ
      layers[key].img = null;
      layers[key].src = null;
      layers[key].x = s ? s.x : canvas.width/2;
      layers[key].y = s ? s.y : canvas.height/2;
      layers[key].scale = s ? s.scale : 1;
    }
  });

  toggleButtons();
  if(jobs.length) return Promise.all(jobs).then(drawAll);
  drawAll();
  return Promise.resolve();
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è: –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
pushHistory();

// –í—ñ–¥–º–∞–ª—é–≤–∞–Ω–Ω—è —à–∞—Ä—É —É –≤–∫–∞–∑–∞–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
function drawLayerTo(ctxTarget, layer){
  if(!layer || !layer.img) return;
  const w = layer.img.width * layer.scale;
  const h = layer.img.height * layer.scale;
  ctxTarget.drawImage(layer.img, layer.x - w/2, layer.y - h/2, w, h);
}
// –ú–∞–ª—é—î–º–æ Love, –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ –æ–±—Ä—ñ–∑–∞—é—á–∏ –ø–æ –∫–æ–ª—É (–ª–∏—à–µ –≤ Preview)
function drawLove(ctxTarget, clip=false){
  const layer = layers.love;
  if(!layer || !layer.img) return;

  const w = layer.img.width * layer.scale;
  const h = layer.img.height * layer.scale;

  ctxTarget.save();
  if (clip && mask.r > 0){
    ctxTarget.beginPath();
    ctxTarget.arc(mask.cx, mask.cy, mask.r, 0, Math.PI*2);
    ctxTarget.clip();
  }
  ctxTarget.drawImage(layer.img, layer.x - w/2, layer.y - h/2, w, h);
  ctxTarget.restore();
}

// –ú–∞–ª—é—î–º–æ –§–û–ù –∑ "–¥—ñ—Ä–∫–æ—é" —É –º—ñ—Å—Ü—ñ –∫–æ–ª–∞ (–∫–æ–ª–∏ bgHoleActive = true)
function drawBgWithHole(ctxTarget){
  if(!layers.bg.img){
    return;
  }

  // —è–∫—â–æ –¥—ñ—Ä–∫—É —Ä–æ–±–∏—Ç–∏ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –º–∞–ª—é—î–º–æ —Ñ–æ–Ω —è–∫ —î
  if(!bgHoleActive || mask.r <= 0){
    drawLayerTo(ctxTarget, layers.bg);
    return;
  }

  // –º–∞–ª—é—î–º–æ —Ñ–æ–Ω —É —Ç–∏–º—á–∞—Å–æ–≤–∏–π canvas
  const off = document.createElement('canvas');
  off.width = canvas.width;
  off.height = canvas.height;
  const octx = off.getContext('2d');

  drawLayerTo(octx, layers.bg);

  // "–≤–∏—Ä—ñ–∑–∞—î–º–æ" –∫–æ–ª–æ, —â–æ–± Love –±—É–ª–æ –≤–∏–¥–Ω–æ –∫—Ä—ñ–∑—å —Ñ–æ–Ω
  octx.globalCompositeOperation = 'destination-out';
  octx.beginPath();
  octx.arc(mask.cx, mask.cy, mask.r, 0, Math.PI*2);
  octx.fill();
  octx.globalCompositeOperation = 'source-over';

  ctxTarget.drawImage(off, 0, 0);
}

function drawAll(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 1. Love (–Ω–∏–∑)
  drawLove(ctx, false);

  // 2. –§–æ–Ω –∑ –¥—ñ—Ä–∫–æ—é (—Å–µ—Ä–µ–¥–∏–Ω–∞)
  drawBgWithHole(ctx);

  // 3. –®–∞–±–ª–æ–Ω (–≤–µ—Ä—Ö)
  if(template.complete) ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
}

function toggleButtons(){
  if(previewMode){
    previewBtn.style.display = 'none';
    downloadBtn.style.display = 'inline-block';
  } else {
    previewBtn.style.display = 'inline-block';
    downloadBtn.style.display = 'none';
  }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É —É —à–∞—Ä
function handleFileLoad(file, key){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const data = e.target.result;
    const img = new Image();
    img.onload = () => {
      layers[key].img = img;
      layers[key].src = data;
      layers[key].x = canvas.width/2;
      layers[key].y = canvas.height/2;
      layers[key].scale = 1;
      activeLayer = key;
      scaleSlider.value = 1; // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–≤–∑—É–Ω–∫–∞ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ
      pushHistory();
      drawAll();
    };
    img.src = data;
  };
  reader.readAsDataURL(file);
}

bgLoader.addEventListener('change', e => handleFileLoad(e.target.files[0], 'bg'));
loveLoader.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const data = ev.target.result;
    const img = new Image();
    img.onload = () => {
      // –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ—é Love ‚Äî –∞–∫—Ç–∏–≤—É—î–º–æ –¥—ñ—Ä–∫—É —É —Ñ–æ–Ω—ñ
      bgHoleActive = true;

      layers.love.img = img;
      layers.love.src = data;
      layers.love.x = canvas.width/2;
      layers.love.y = canvas.height/2;
      layers.love.scale = 1;

      activeLayer = 'love';
      scaleSlider.value = 1;

      pushHistory();
      drawAll();
    };
    img.src = data;
  };
  reader.readAsDataURL(file);
});


// Drag (–º—ñ—à–∫–∞)
canvas.addEventListener('mousedown', e => {
  if(previewMode || !activeLayer) return;
  dragging = true;
  dragStartX = e.offsetX - layers[activeLayer].x;
  dragStartY = e.offsetY - layers[activeLayer].y;
});
canvas.addEventListener('mousemove', e => {
  if(previewMode || !dragging || !activeLayer) return;
  layers[activeLayer].x = e.offsetX - dragStartX;
  layers[activeLayer].y = e.offsetY - dragStartY;
  drawAll();
});
canvas.addEventListener('mouseup', () => { 
  if(previewMode) return;
  if(dragging){ dragging=false; pushHistory(); } 
});
canvas.addEventListener('mouseleave', () => { 
  if(previewMode) return;
  if(dragging){ dragging=false; pushHistory(); } 
});

// Touch support
canvas.addEventListener('touchstart', e => {
  if(previewMode || !activeLayer) return;
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  dragging = true;
  dragStartX = t.clientX - rect.left - layers[activeLayer].x;
  dragStartY = t.clientY - rect.top - layers[activeLayer].y;
  e.preventDefault();
});
canvas.addEventListener('touchmove', e => {
  if(previewMode || !dragging || !activeLayer) return;
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  layers[activeLayer].x = t.clientX - rect.left - dragStartX;
  layers[activeLayer].y = t.clientY - rect.top - dragStartY;
  drawAll(); e.preventDefault();
});
canvas.addEventListener('touchend', () => { 
  if(previewMode) return;
  if(dragging){ dragging=false; pushHistory(); } 
});


// Undo: –≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ snapshot (–ø–æ –∫—Ä–æ–∫—É)
undoBtn.addEventListener('click', () => {
  if(history.length <= 1) return; // –Ω—ñ—á–æ–≥–æ —Å–∫–∞—Å–æ–≤—É–≤–∞—Ç–∏
  history.pop(); // –≤–∏–¥–∞–ª—è—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
  const prev = history[history.length-1];
  applySnapshot(prev);
});

// Preview: –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –º–∞—Å–∫—É –∑ —à–∞–±–ª–æ–Ω—É (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å —à–∞–±–ª–æ–Ω—É —è–∫ –≤–∏—Ä—ñ–∑)
previewBtn.addEventListener('click', () => {
  previewMode = true;
  pushHistory();
  toggleButtons();
  drawAll();
});

// Download: –ø—Ä–æ—Å—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π canvas (–≤–∫–ª—é—á–Ω–æ –∑ –º–∞—Å–∫–æ—é, —è–∫—â–æ previewMode)
downloadBtn.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'composition.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});

// –∫–æ–ª–∏ —à–∞–±–ª–æ–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è, –ø–µ—Ä–µ–º–∞–ª—é—î–º–æ
template.onload = function(){
  // –º–∞–ª—é—î–º–æ —à–∞–±–ª–æ–Ω —É –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–æ—Ç–Ω–æ
  let tempCanvas = document.createElement("canvas");
  tempCanvas.width = canvas.width;
  tempCanvas.height = canvas.height;
  let tctx = tempCanvas.getContext("2d");
  tctx.drawImage(template, 0, 0, canvas.width, canvas.height);

  let imgData = tctx.getImageData(0, 0, canvas.width, canvas.height);
  let data = imgData.data;

  let xs = [], ys = [];
  for(let y=0; y<canvas.height; y++){
    for(let x=0; x<canvas.width; x++){
      let alpha = data[(y*canvas.width + x)*4 + 3]; // –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª
      if(alpha < 50){ // –ø—Ä–æ–∑–æ—Ä–∏–π –ø—ñ–∫—Å–µ–ª—å
        xs.push(x);
        ys.push(y);
      }
    }
  }

  if(xs.length > 0){
    // —Ü–µ–Ω—Ç—Ä –≤–∏—Ä—ñ–∑—É
    let avgX = xs.reduce((a,b)=>a+b,0)/xs.length;
    let avgY = ys.reduce((a,b)=>a+b,0)/ys.length;
    mask.cx = avgX;
    mask.cy = avgY;

    // —Ä–∞–¥—ñ—É—Å
    let maxDist = 0;
    for(let i=0; i<xs.length; i++){
      let dx = xs[i]-avgX, dy = ys[i]-avgY;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if(dist > maxDist) maxDist = dist;
    }
    mask.r = maxDist;
  }

  drawAll();
};


// –º–∞–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
applySnapshot(history[0] || makeSnapshot());

// —Ñ—É–Ω–∫—Ü—ñ—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è / —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è
function setDisabled(state) {
  // –±–µ—Ä–µ–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è, –∫—Ä—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ —Ç–∞ —Ñ–æ–Ω—É
  const controls = document.querySelectorAll("input:not(#background):not(#love), #scaleSlider");

  controls.forEach(ctrl => {
    if (state) {
      ctrl.disabled = true;
      ctrl.classList.add("disabled");
    } else {
      ctrl.disabled = false;
      ctrl.classList.remove("disabled");
    }
  });
}

// –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ–≥–ª—è–¥"
document.getElementById("previewBtn").addEventListener("click", () => {
  setDisabled(true);
});

// –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ "Undo"
document.getElementById("undoBtn").addEventListener("click", () => {
  setDisabled(false);
});
</script>
</body>
</html>
