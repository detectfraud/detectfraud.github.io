<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</title>
<style>
body { text-align:center; font-family:sans-serif; }
.venwin {
  background: #fff;
  border-radius:10px;
  padding:10px;
  display:inline-block;
}
canvas {
  border:3px solid #bbb;
  border-radius:3%;
  box-shadow:0 6px 18px rgba(0,0,0,.1);
  display:block;
  margin:10px auto;
}
</style>
</head>
<body>

<fieldset class="venwin" style="height:auto;">
  <center>
    <span style="color:#990000;font-size:x-large;">–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ</span><br><br>
    <canvas id="canvas" width="900" height="600"></canvas>
    <br><br>
    <label>–§–æ–Ω:&nbsp;&nbsp;<input type="file" id="bgLoader" accept="image/*"></label>
    <label>–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö:&nbsp;&nbsp;<input type="file" id="loveLoader" accept="image/*"></label>
    <br><br>
    <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1" style="width:400px;">
    <br><br>
    <button id="undoBtn">‚ü≤ Undo</button>&nbsp;&nbsp;&nbsp;&nbsp;<button id="downloadBtn">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  </center>
</fieldset>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let template = new Image();
template.src = "images/LoveStone.png"; // PNG –∑ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—é

let layers = {
  bg: { img: null, x: 0, y: 0, scale: 1 },
  love: { img: null, x: 0, y: 0, scale: 1 }
};

let activeLayer = null;
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

// —ñ—Å—Ç–æ—Ä—ñ—è –¥–ª—è Undo
let history = [];

// –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ input
document.getElementById("bgLoader").addEventListener("change", e => {
  loadImage(e.target.files[0], img => {
    layers.bg = { img, x: canvas.width/2, y: canvas.height/2, scale: 1 };
    activeLayer = "bg";
    document.getElementById("scaleSlider").value = 1; // —Å–∫–∏–¥–∞–Ω–Ω—è —Å–ª–∞–π–¥–µ—Ä–∞
    saveState();
    drawAll();
  });
});

document.getElementById("loveLoader").addEventListener("change", e => {
  loadImage(e.target.files[0], img => {
    layers.love = { img, x: canvas.width/2, y: canvas.height/2, scale: 1 };
    activeLayer = "love";
    document.getElementById("scaleSlider").value = 1; // —Å–∫–∏–¥–∞–Ω–Ω—è —Å–ª–∞–π–¥–µ—Ä–∞
    saveState();
    drawAll();
  });
});

function loadImage(file, callback) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => callback(img);
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// —Å–ª–∞–π–¥–µ—Ä –º–∞—Å—à—Ç–∞–±—É
document.getElementById("scaleSlider").addEventListener("input", e => {
  if (!activeLayer) return;
  layers[activeLayer].scale = parseFloat(e.target.value);
  saveState();
  drawAll();
});

// drag –º–∏—à–∫–æ—é
canvas.addEventListener("mousedown", e => {
  if (!activeLayer) return;
  isDragging = true;
  dragOffsetX = e.offsetX - layers[activeLayer].x;
  dragOffsetY = e.offsetY - layers[activeLayer].y;
});

canvas.addEventListener("mousemove", e => {
  if (!isDragging || !activeLayer) return;
  layers[activeLayer].x = e.offsetX - dragOffsetX;
  layers[activeLayer].y = e.offsetY - dragOffsetY;
  drawAll();
});

canvas.addEventListener("mouseup", () => {
  if (isDragging) {
    isDragging = false;
    saveState();
  }
});

// —Ç–∞—á –ø—ñ–¥—Ç—Ä–∏–º–∫–∞
canvas.addEventListener("touchstart", e => {
  if (!activeLayer) return;
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  isDragging = true;
  dragOffsetX = x - layers[activeLayer].x;
  dragOffsetY = y - layers[activeLayer].y;
});

canvas.addEventListener("touchmove", e => {
  if (!isDragging || !activeLayer) return;
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  layers[activeLayer].x = touch.clientX - rect.left - dragOffsetX;
  layers[activeLayer].y = touch.clientY - rect.top - dragOffsetY;
  drawAll();
});

canvas.addEventListener("touchend", () => {
  if (isDragging) {
    isDragging = false;
    saveState();
  }
});

// Undo
document.getElementById("undoBtn").addEventListener("click", () => {
  if (history.length > 1) {
    history.pop(); // –≤–∏–¥–∞–ª—è—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
    const prev = history[history.length-1];
    layers = JSON.parse(JSON.stringify(prev));
    drawAll();
  }
});

// –º–∞–ª—é–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö —à–∞—Ä—ñ–≤
function drawAll() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // –º–∞—Å–∫–∞ –∫—Ä—É–≥–æ–º (–ø–æ —Ü–µ–Ω—Ç—Ä—É)
  ctx.save();
  ctx.beginPath();
  ctx.arc(canvas.width/2, canvas.height/2, 250, 0, Math.PI*2, true); // —Ä–∞–¥—ñ—É—Å 250px
  ctx.closePath();
  ctx.clip();

  if (layers.bg.img) drawLayer(layers.bg);
  if (layers.love.img) drawLayer(layers.love);

  ctx.restore();

  // —à–∞–±–ª–æ–Ω –∑–≤–µ—Ä—Ö—É
  ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
}

function drawLayer(layer) {
  const w = layer.img.width * layer.scale;
  const h = layer.img.height * layer.scale;
  ctx.drawImage(layer.img, layer.x - w/2, layer.y - h/2, w, h);
}

// –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É
function saveState() {
  history.push(JSON.parse(JSON.stringify(layers)));
}

document.getElementById("downloadBtn").addEventListener("click", () => {
  const link = document.createElement('a');
  link.download = 'composition.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});
</script>
</body>
</html>
