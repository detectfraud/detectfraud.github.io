<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Камінь любові</title>
<style>
body { text-align:center; font-family:sans-serif; }
.venwin {
  background: #fff;
  border-radius:10px;
  padding:10px;
  display:inline-block;
}
canvas {
  border:3px solid #bbb;
  border-radius:3%;
  box-shadow:0 6px 18px rgba(0,0,0,.1);
  display:block;
  margin:10px auto;
}
</style>
</head>
<body>

<fieldset class="venwin">
  <span style="color:#990000;font-size:x-large;">Камінь любові</span><br><br>
  <input type="file" id="upload" accept="image/*"><br><br>
  <canvas id="c" width="900" height="600"></canvas><br>
  <input type="range" id="scale" min="0.1" max="2" step="0.01" value="1" style="width:300px;"><br><br>
  <button id="download">Завантажити</button>
</fieldset>

<script>
const URLS = {
  shablon:  "images/shablon.png",
  template: "images/LoveStone.png",
  bg:       "images/priroda.jpg"
};

let tpl = null;
let bg = null;
let lovers = null;
let loverPos = {x:0,y:0};
let scale = 1;

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const upload = document.getElementById('upload');
const range = document.getElementById('scale');

// Завантаження зображень
function loadImage(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>res(img);
    img.onerror = ()=>rej('Не вдалося завантажити '+src);
    img.src = src;
  });
}

// Малювання
function draw(){
  if(!bg || !tpl) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(bg,0,0,canvas.width,canvas.height);
  if(lovers){
    ctx.save();
    ctx.translate(loverPos.x, loverPos.y);
    ctx.scale(scale, scale);
    ctx.drawImage(lovers,-lovers.width/2,-lovers.height/2);
    ctx.restore();
  }
  ctx.drawImage(tpl,0,0,canvas.width,canvas.height);
}

// Ініціалізація
async function init(){
  try{
    [tpl, bg] = await Promise.all([loadImage(URLS.shablon), loadImage(URLS.bg)]);
    draw();
  }catch(e){console.error(e);}
}
init();

// Завантаження фото користувача
upload.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    const img = new Image();
    img.onload = ()=>{
      lovers = img;
      loverPos.x = canvas.width/2;
      loverPos.y = canvas.height/2;
      scale = 1;
      range.value = 1;
      draw();
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Масштабування
range.addEventListener('input', e=>{
  scale = parseFloat(e.target.value);
  draw();
});

// Drag мишею
let drag = false;
canvas.addEventListener('mousedown', ()=>drag=true);
canvas.addEventListener('mouseup', ()=>drag=false);
canvas.addEventListener('mousemove', e=>{
  if(drag && lovers){
    loverPos.x = e.offsetX;
    loverPos.y = e.offsetY;
    draw();
  }
});

// Завантаження PNG
document.getElementById('download').addEventListener('click', ()=>{
  const out = document.createElement('canvas');
  out.width = 900;
  out.height = 600;
  const octx = out.getContext('2d');

  octx.drawImage(bg,0,0,out.width,out.height);
  if(lovers){
    octx.save();
// коефіцієнти масштабу між робочим canvas і вихідним
const kx = out.width / canvas.width;
const ky = out.height / canvas.height;

// переносимо точку в реальні координати (де фото стояло на екрані)
octx.translate(loverPos.x * kx, loverPos.y * ky);

// масштабуємо з урахуванням коефіцієнта
const totalScale = scale * ((kx + ky) / 2); 
octx.scale(totalScale, totalScale);

// малюємо фото
octx.drawImage(lovers, -lovers.width / 2, -lovers.height / 2);
octx.restore();

  }
  octx.drawImage(tpl,0,0,out.width,out.height);

  const link = document.createElement('a');
  link.download = 'love-stone.png';
  link.href = out.toDataURL('image/png');
  link.click();
});

  //
  async function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous"; // можна прибрати, якщо картинки локальні
    img.onload = () => {
      console.log("✅ Завантажено:", src);
      resolve(img);
    };
    img.onerror = () => {
      console.error("❌ Помилка завантаження:", src);
      reject();
    };
    img.src = src;
  });
}

</script>

</body>
</html>
