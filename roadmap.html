<fieldset class="venwin" style="height:auto;">
  <br>
  <center>
    <span style="color:#990000;font-size:x-large;">Камінь любові</span>
    <br><br><br>
    <input type="file" id="upload" accept="image/*"><br><br>
    <canvas id="c" width="630" height="420"></canvas><br>
    <input type="range" id="scale" min="0.1" max="2" step="0.01" value="1" style="width:300px;">
    <br><br>
 <button id="download">Завантажити</button>    
  </center>      
</fieldset>

<script>
const URLS = {
  shablon:  "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg9bJQbJi-fyz57bwsVV6f7zSVPKhSPMg3UKkjCpagku0fC5pqfzQtwOjZZmTVrU0GJMlRmulfO-VVjySaIg_y9OnsKmWawfOYwN4BX44v8QCo1tw1p2J7n5BxZuDPoN8roMsOugWQ4c_HW6eUiUjXW8s7aV7FF9PGMYx1Ye_dsSBFx0w/s1600/shablon.png",
  template: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgex6MH_sN8E4z5cwka5UprI8NeyBSSq9c1koMT3xOjT7ZJy8kRMw-YwgkqSUmzRbkyg0De5a-TydSLkDKchAWWEpAlP7XqXw3F9ZJTyzEEVKvzu4PBLcJ7jLb4MjZcXSsfqAHSaKvXIqFR4hg2egBTR0J8CvtxKfLCum07T0Qlaiia9w/s1600/LoveStone.png",
  bg:       "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiAYUyx8_q9om0Y0Az4bbieFk549Q5bAkod7sPLkjWvDbHzFKiTWauuhB1oJsbrIC0ljBNnP_6VaVoe-Os9zOcIi_Tjd7lRc2uVS0r2y8v5e2ug6vkljDFl-lCXPE0RFP4naCixsS7KOjmSRKkSSmjaWPnr_uKwvQinsuRgg1XCNDA8Jg/s1600/priroda.jpg"
};

let lovers = null;
let loverPos = {x:0, y:0};
let drag = false;
let scale = 1;

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const upload = document.getElementById("upload");
const range = document.getElementById("scale");

let tpl, bg;

// Завантаження зображень-шаблонів
function load(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload=()=>res(img);
    img.onerror=()=>rej();
    img.src=src;
  });
}

async function init(){
  [tpl, bg] = await Promise.all([load(URLS.shablon), load(URLS.bg)]);
  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // фон
  ctx.drawImage(bg,0,0,canvas.width,canvas.height);

  if(lovers){
    ctx.save();
    ctx.translate(loverPos.x, loverPos.y);
    ctx.scale(scale, scale);
    ctx.drawImage(lovers, -lovers.width/2, -lovers.height/2);
    ctx.restore();
  }

  // камінь поверх
  ctx.drawImage(tpl,0,0,canvas.width,canvas.height);
}

// Завантаження фото закоханих
upload.addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    lovers = new Image();
    lovers.onload=()=>{
      loverPos.x = canvas.width/2;
      loverPos.y = canvas.height/2;
      scale = 1;
      draw();
    };
    lovers.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Масштабування повзунком
range.addEventListener("input", e=>{
  scale = parseFloat(e.target.value);
  draw();
});

// Перетягування мишею / пальцем
canvas.addEventListener("mousedown", e=>{
  drag=true;
});
canvas.addEventListener("mouseup", ()=>drag=false);
canvas.addEventListener("mousemove", e=>{
  if(drag && lovers){
    loverPos.x = e.offsetX;
    loverPos.y = e.offsetY;
    draw();
  }
});

// Для мобільного
canvas.addEventListener("touchstart", ()=>drag=true);
canvas.addEventListener("touchend", ()=>drag=false);
canvas.addEventListener("touchmove", e=>{
  if(drag && lovers){
    const rect = canvas.getBoundingClientRect();
    loverPos.x = e.touches[0].clientX - rect.left;
    loverPos.y = e.touches[0].clientY - rect.top;
    draw();
  }
});
    // Завантаження готового фото
    document.getElementById("download").addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "love-stone.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  
init();
</script>

<style>
  .venwin{background:transparent url(https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjghIwEmgtr9VAIzGM4eS8BdLA1nptupwYDch46JvrMH9AILVqnNpUX_vxUtQe2Kr-eNLgXcUu_dfNCc7P45vPblF37xpoN8dbLsm9VHiMKmYf58ixmJeQHTY4R4hvGXj0nC7SqiD_2UWRGvIDgUrvZqoVqq8qT61yJB846igsv4ceY7Q/s1600/fon.png);border-radius:10px}
  canvas{border:3px solid #bbb;border-radius:3%;box-shadow:0 6px 18px rgba(0,0,0,.1)}
</style>
