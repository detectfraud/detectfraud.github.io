<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
<style>
body { font-family: sans-serif; text-align:center; background:url(https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjghIwEmgtr9VAIzGM4eS8BdLA1nptupwYDch46JvrMH9AILVqnNpUX_vxUtQe2Kr-eNLgXcUu_dfNCc7P45vPblF37xpoN8dbLsm9VHiMKmYf58ixmJeQHTY4R4hvGXj0nC7SqiD_2UWRGvIDgUrvZqoVqq8qT61yJB846igsv4ceY7Q/s1600/fon.png) repeat scroll top left; }
.venwin {  border-radius:10px;  display:inline-block; background:url(https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjghIwEmgtr9VAIzGM4eS8BdLA1nptupwYDch46JvrMH9AILVqnNpUX_vxUtQe2Kr-eNLgXcUu_dfNCc7P45vPblF37xpoN8dbLsm9VHiMKmYf58ixmJeQHTY4R4hvGXj0nC7SqiD_2UWRGvIDgUrvZqoVqq8qT61yJB846igsv4ceY7Q/s1600/fon.png) repeat scroll top left; }
canvas { border:3px solid #bbb; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:block; margin:10px auto; }
#scaleSlider { width:420px;}
button { padding:8px 12px; cursor:pointer; border-radius:8px; }
.disabled { pointer-events:none; opacity:.5; filter:grayscale(100%); }
.gallery-container { display:flex; align-items:flex-start; justify-content:center; gap:10px; margin-top:20px; }
.gallery-block { display:flex; flex-direction:column; align-items:center; gap:10px; }
.thumbnails { display:flex; gap:10px; overflow:hidden; width:600px; justify-content:center; }
.thumb { width:108px; height:72px; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 0 6px rgba(0,0,0,0.3); transition:all 0.3s ease; z-index:1; }
.collage { position:relative; display:inline-block; margin-top:40px; }
.photo-block { margin-left:100px; }
</style>
</head>
<body>

<fieldset class="venwin" style="height:auto;">
  <div class="collage" id="collage">
    <canvas id="canvas" width="900" height="600" style="border:1px solid #ccc;"></canvas>
  </div>

  <br>
  <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1"><br><br>

  <!-- –ì–∞–ª–µ—Ä–µ—è —Ñ–æ–Ω—ñ–≤ -->
  <div class="gallery-container">
    <div class="gallery-block" id="vowsi">
      <b>–§–æ–Ω</b>
      <div>
        <span class="arrow" onclick="prevSlide()">&#10094;</span>
        <div class="thumbnails" id="thumbs"></div>
        <span class="arrow" onclick="nextSlide()">&#10095;</span>
      </div>
    </div>

    <div class="gallery-block photo-block">
      <b>–§–æ—Ç–æ</b>
      <label id="fot" title="–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö"></label>
    </div>
  </div>

  <!-- –ì–∞–ª–µ—Ä–µ—è –∫–ª—è—Ç–≤ -->
  <div class="gallery-container vows" id="vowse" style="display:none;">
    <div class="gallery-block">
      <div class="labels">
        <span class="label1">–ù–∞–¥–ø–∏—Å</span>
        <span class="label2">–ö–ª—è—Ç–≤–∞ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö</span>
      </div>
      <div class="gallery-row">
        <span class="arow" onclick="prevVow()">&#10094;</span>
        <div class="thumbnails" id="thumbsVows"></div>
        <span class="arow" onclick="nextVow()">&#10095;</span>
      </div>
    </div>
  </div>

  <br><br>
  <div>
    <button id="undoBtn" type="button">‚ü≤ Undo</button>
    <button id="previewBtn" type="button">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
    <button id="downloadBtn" type="button" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    <button id="updateBtn" type="button">UPDATE</button>
  </div>
</fieldset>

<!-- –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ —ñ–Ω–ø—É—Ç–∏ -->
<input type="file" id="bgLoader" style="display:none">
<input type="file" id="loveLoader" style="display:none">
<input type="file" id="label1Loader" style="display:none">
<input type="file" id="label2Loader" style="display:none">

<script>
/* === Collage JS v2 ‚Äî label1/label2 —è–∫ —à–∞—Ä–∏ (—Ä—É—Ö/–º–∞—Å—à—Ç–∞–±) === */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const thumbs = document.getElementById('thumbs');
const thumbsVows = document.getElementById('thumbsVows');
const loveLoader = document.getElementById('loveLoader');
const label1Loader = document.getElementById('label1Loader');
const label2Loader = document.getElementById('label2Loader');
const scaleSlider = document.getElementById('scaleSlider');
const undoBtn = document.getElementById('undoBtn');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');
const bgLoader = document.getElementById('bgLoader');
const collage = document.getElementById('collage');
const vowse = document.getElementById('vowse');
const vowsi = document.getElementById('vowsi');
const photoBlock = document.querySelector('.photo-block');

/* === –ì–∞–ª–µ—Ä–µ—è —Ñ–æ–Ω—ñ–≤ === */
const url = "https://detectfraud.github.io/gallery/";
const images = ["nature(1)","nature(2)","nature(3)","nature(4)","nature(5)","nature(6)","nature(7)","nature(8)","nature(9)","Fon"];
const fullImages = images.map(name => url + name + ".jpeg");
let startIndex = 0;

function renderThumbnails(){
  thumbs.innerHTML = "";
  fullImages.slice(startIndex, startIndex+3).forEach(src => createThumb(src, thumbs, false));
}
function createThumb(src, container, isVow){
  const wrapper = document.createElement("div");
  wrapper.className = "thumb-wrapper";
  const imgName = src.split("/").pop().split(".")[0];
  const thumb = document.createElement("img"); thumb.className="thumb"; thumb.src = src;
  const big = document.createElement("img"); big.className="imagbox"; big.src = src;
  if(isVow){
    thumb.onclick = () => addOverlay(src,true);
  } else {
    if(imgName === "Fon"){
      thumb.title = "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤—ñ–π —Ñ–æ–Ω";
      thumb.onclick = () => bgLoader.click();
    } else {
      thumb.onclick = () => handleFileFromGallery(src, "bg");
    }
  }
  wrapper.appendChild(thumb);
  wrapper.appendChild(big);
  container.appendChild(wrapper);
}
function prevSlide(){ startIndex = (startIndex-3+fullImages.length) % fullImages.length; renderThumbnails(); }
function nextSlide(){ startIndex = (startIndex+3) % fullImages.length; renderThumbnails(); }

/* –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≥–æ—Ç–æ–≤–∏–π —Ñ–æ–Ω —ñ–∑ –≥–∞–ª–µ—Ä–µ—ó */
function handleFileFromGallery(src, key){
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = () => {
    layers[key].img = img;
    layers[key].src = src;
    layers[key].x = canvas.width/2;
    layers[key].y = canvas.height/2;
    layers[key].scale = 1;
    activeLayer = key;
    scaleSlider.value = 1;
    pushHistory();
    drawAll();
  };
  img.src = src;
}

/* –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ªi–≤ —É —à–∞—Ä–∏ */
function handleFileLoad(file, key){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const data = e.target.result;
    const img = new Image();
    img.onload = () => {
      layers[key].img = img;
      layers[key].src = data;
      layers[key].x = canvas.width/2;
      layers[key].y = canvas.height/2;
      layers[key].scale = 1;
      activeLayer = key;
      scaleSlider.value = 1;
      pushHistory();
      drawAll();
    };
    img.src = data;
  };
  reader.readAsDataURL(file);
}

/* –ø—Ä–∏–≤'—è–∑–∫–∏ —ñ–Ω–ø—É—Ç—ñ–≤ */
if (bgLoader) bgLoader.addEventListener('change', e => handleFileLoad(e.target.files[0], 'bg'));
if (loveLoader) loveLoader.addEventListener('change', e => handleFileLoad(e.target.files[0], 'love'));
if (label1Loader) label1Loader.addEventListener('change', e => handleFileLoad(e.target.files[0], 'label1'));
if (label2Loader) label2Loader.addEventListener('change', e => handleFileLoad(e.target.files[0], 'label2'));
document.getElementById("fot").onclick = () => { if (loveLoader) loveLoader.click(); };

/* –≥–∞–ª–µ—Ä–µ—è –∫–ª—è—Ç–≤ */
const vows = ["LoveStones","Eternity","Fidelity","Joy","LoveStones","Love","Strength","Tenderness","LoveStones","Trust","Unity","Heart"];
const fullVows = vows.map(name => url + name + ".png");
let vowIndex = 0;
function renderVows(){ thumbsVows.innerHTML = ""; fullVows.slice(vowIndex, vowIndex+4).forEach(src => createThumb(src, thumbsVows, true)); }
function prevVow(){ vowIndex = (vowIndex-4+fullVows.length) % fullVows.length; renderVows(); }
function nextVow(){ vowIndex = (vowIndex+4) % fullVows.length; renderVows(); }

/* –®–∞—Ä–∏ —ñ –º–∞—Å–∫–∞ (–∫—Ä—É–≥–ª–∞ –¥—ñ—Ä–∞) */
const template = new Image(); template.src = 'images/composit.png';
const HOLE_OFFSET_X = 6, HOLE_OFFSET_Y = -115, HOLE_RADIUS = 98;
let mask = { cx: canvas.width/2 + HOLE_OFFSET_X, cy: canvas.height/2 + HOLE_OFFSET_Y, r: HOLE_RADIUS };

/* --- layers (–¥–æ–¥–∞–Ω—ñ label1/label2) --- */
let layers = {
  bg:    { img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 },
  love:  { img:null, src:null, x:canvas.width/2, y:canvas.height/2, scale:1 },
  label1:{ img:null, src:null, x:canvas.width/2, y:canvas.height-80, scale:1 },
  label2:{ img:null, src:null, x:canvas.width/2, y:canvas.height-40, scale:1 }
};

let activeLayer = null;
let previewMode = false;
let bgHoleActive = true;

/* –Ü—Å—Ç–æ—Ä—ñ—è */
const history = [];
const MAX_HISTORY = 20;
function makeSnapshot(){
  return {
    bg: {...layers.bg},
    love: {...layers.love},
    label1: {...layers.label1},
    label2: {...layers.label2},
    previewMode, activeLayer, bgHoleActive
  };
}
function pushHistory(){ history.push(makeSnapshot()); if(history.length > MAX_HISTORY) history.shift(); }

/* applySnapshot –ø—Ä–∞—Ü—é—î –∑ label1/label2 */
function applySnapshot(s){
  if(!s) return;
  previewMode = !!s.previewMode;
  activeLayer = s.activeLayer || null;
  bgHoleActive = !!s.bgHoleActive;

  ['bg','love','label1','label2'].forEach(key => {
    const v = s[key];
    if(v && v.src){
      const img = new Image();
      img.onload = () => {
        layers[key].img = img;
        layers[key].src = v.src;
        layers[key].x = v.x;
        layers[key].y = v.y;
        layers[key].scale = v.scale;
        drawAll();
      };
      img.src = v.src;
    } else {
      layers[key].img = null;
      layers[key].src = null;
      layers[key].x = v ? v.x : canvas.width/2;
      layers[key].y = v ? v.y : canvas.height/2;
      layers[key].scale = v ? v.scale : 1;
    }
  });

  toggleButtons();
}

/* –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ—Å—Ç–æ—Ä—ñ—ó (–ø–µ—Ä—à–∏–π —Å—Ç–∞–Ω) */
pushHistory();

/* –ú–ê–õ–Æ–í–ê–ù–ù–Ø */
function drawLayerTo(ctxTarget, layer){
  if(!layer || !layer.img) return;
  const w = layer.img.width * layer.scale;
  const h = layer.img.height * layer.scale;
  ctxTarget.drawImage(layer.img, layer.x - w/2, layer.y - h/2, w, h);
}
function drawLove(ctxTarget, clip=false){
  const L = layers.love; if(!L || !L.img) return;
  const w = L.img.width * L.scale, h = L.img.height * L.scale;
  ctxTarget.save();
  if(clip && mask.r > 0){ ctxTarget.beginPath(); ctxTarget.arc(mask.cx,mask.cy,mask.r,0,Math.PI*2); ctxTarget.clip(); }
  ctxTarget.drawImage(L.img, L.x - w/2, L.y - h/2, w, h);
  ctxTarget.restore();
}
function drawBgWithHole(ctxTarget){
  if(!layers.bg.img) return;
  if(!bgHoleActive || mask.r <= 0){ drawLayerTo(ctxTarget, layers.bg); return; }
  const off = document.createElement('canvas'); off.width = canvas.width; off.height = canvas.height;
  const octx = off.getContext('2d'); drawLayerTo(octx, layers.bg);
  octx.globalCompositeOperation = 'destination-out';
  octx.beginPath(); octx.arc(mask.cx, mask.cy, mask.r, 0, Math.PI*2); octx.fill();
  octx.globalCompositeOperation = 'source-over';
  ctxTarget.drawImage(off, 0, 0);
}

/* –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–ª–æ–µ–≤ (label1/label2 —Ç–æ–∂–µ) */
function drawAll(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!previewMode){
    drawBgWithHole(ctx);
    drawLove(ctx, false);
  } else {
    drawLove(ctx, true);
    drawBgWithHole(ctx);
  }

  if(layers.label1.img) drawLayerTo(ctx, layers.label1);
  if(layers.label2.img) drawLayerTo(ctx, layers.label2);

  // —Ä–∞–º–∫–∞ –Ω–∞–≤–∫–æ–ª–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —à–∞—Ä—É (–∫–æ—Ä–∏—Å–Ω–æ –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ)
  if(activeLayer && layers[activeLayer] && layers[activeLayer].img && !previewMode){
    const L = layers[activeLayer];
    const w = L.img.width * L.scale, h = L.img.height * L.scale;
    const left = L.x - w/2, top = L.y - h/2;
    ctx.save();
    ctx.strokeStyle = 'rgba(255,0,0,0.9)';
    ctx.lineWidth = 2;
    ctx.setLineDash([6,4]);
    ctx.strokeRect(left-4, top-4, w+8, h+8);
    ctx.restore();
  }

  if(template.complete) ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
}

/* –í–∏–∑–Ω–∞—á–∞—î —à–∞—Ä –ø—ñ–¥ —Ç–æ—á–∫–æ—é (–ø–æ–≤–µ—Ä—Ç–∞—î –∫–ª—é—á —à–∞—Ä—É –∞–±–æ null) */
/* –ü–æ—Ä—è–¥–æ–∫: label2 (—Ç–æ–ø), label1, love, bg (–Ω–∏–∂—á–µ) */
function getTopLayerAt(x, y){
  const order = ['label2','label1','love','bg'];
  for(const key of order){
    const L = layers[key];
    if(!L || !L.img) continue;
    const w = L.img.width * L.scale, h = L.img.height * L.scale;
    const left = L.x - w/2, top = L.y - h/2;
    if(x >= left && x <= left + w && y >= top && y <= top + h) return key;
  }
  return null;
}

/* --- –ü–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è + –≤–∏–±—ñ—Ä —à–∞—Ä—É (–º–∏—à–∞) --- */
let dragging = false, dragStartX = 0, dragStartY = 0;

canvas.addEventListener('mousedown', e => {
  if(previewMode) return;
  const x = e.offsetX, y = e.offsetY;
  const layerUnder = getTopLayerAt(x,y);
  if(layerUnder){
    activeLayer = layerUnder;
    dragging = true;
    dragStartX = x - layers[activeLayer].x;
    dragStartY = y - layers[activeLayer].y;
    drawAll();
  } else {
    // –∫–ª—ñ–∫ –ø–æ –ø–æ—Ä–æ–∂–Ω—å–æ–º—É –º—ñ—Å—Ü—é ‚Äî –∑–Ω—è—Ç–∏ –≤–∏–±—ñ—Ä (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
    activeLayer = null;
    drawAll();
  }
});

canvas.addEventListener('mousemove', e => {
  if(previewMode || !dragging || !activeLayer) return;
  layers[activeLayer].x = e.offsetX - dragStartX;
  layers[activeLayer].y = e.offsetY - dragStartY;
  drawAll();
});

function stopDrag(){
  if(previewMode) return;
  if(dragging){
    dragging = false;
    pushHistory(); // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –∫—ñ–Ω—Ü–µ–≤–∏–π —Å—Ç–∞–Ω
  }
}
canvas.addEventListener('mouseup', stopDrag);
canvas.addEventListener('mouseleave', stopDrag);

/* --- Touch support (–≤–∏–±—ñ—Ä —à–∞—Ä—É —Ç–∞ –ø–µ—Ä–µ—Ç—è–≥) --- */
canvas.addEventListener('touchstart', e => {
  if(previewMode) return;
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const x = t.clientX - rect.left, y = t.clientY - rect.top;
  const layerUnder = getTopLayerAt(x,y);
  if(layerUnder){
    activeLayer = layerUnder;
    dragging = true;
    dragStartX = x - layers[activeLayer].x;
    dragStartY = y - layers[activeLayer].y;
    drawAll();
    e.preventDefault();
  }
});
canvas.addEventListener('touchmove', e => {
  if(previewMode || !dragging || !activeLayer) return;
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const x = t.clientX - rect.left, y = t.clientY - rect.top;
  layers[activeLayer].x = x - dragStartX;
  layers[activeLayer].y = y - dragStartY;
  drawAll();
  e.preventDefault();
});
canvas.addEventListener('touchend', () => {
  stopDrag();
});

/* –ú–∞—Å—à—Ç–∞–± —á–µ—Ä–µ–∑ –ø–æ–≤–∑—É–Ω–æ–∫: input ‚Äî –ø–ª–∞–≤–Ω–µ, change ‚Äî –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ —ñ—Å—Ç–æ—Ä—ñ—é */
scaleSlider.addEventListener('input', () => {
  if(!activeLayer) return;
  layers[activeLayer].scale = parseFloat(scaleSlider.value);
  drawAll();
});
scaleSlider.addEventListener('change', () => {
  if(!activeLayer) return;
  pushHistory();
});

/* Undo / Preview / Download */
undoBtn.addEventListener('click', () => {
  if(history.length <= 1) return;
  history.pop();
  applySnapshot(history[history.length-1]);
});
previewBtn.addEventListener('click', () => {
  previewMode = true; pushHistory(); toggleButtons(); drawAll();
});
downloadBtn.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'composition.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});

/* UI toggle */
function toggleButtons(){
  if(previewMode){
    previewBtn.style.display = 'none';
    downloadBtn.style.display = 'inline-block';
    if(vowsi) vowsi.style.display = 'none';
    if(photoBlock) photoBlock.style.display = 'none';
    if(vowse) vowse.style.display = 'inline-block';
    setDisabled(true);
  } else {
    previewBtn.style.display = 'inline-block';
    downloadBtn.style.display = 'none';
    if(vowsi) vowsi.style.display = 'inline-block';
    if(photoBlock) photoBlock.style.display = 'inline-block';
    if(vowse) vowse.style.display = 'none';
    setDisabled(false);
  }
}
function setDisabled(state){
  [thumbs, loveLoader].forEach(el=>{
    if(!el) return;
    el.disabled = !!state;
    el.classList.toggle('disabled', !!state);
  });
}

/* template onload */
template.onload = () => { drawAll(); };

/* –°—Ç–∞—Ä—Ç: —Ä–µ–Ω–¥–µ—Ä –≥–∞–ª–µ—Ä–µ–π —ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–µ—Ä—à–æ–≥–æ snapshot */
renderThumbnails();
renderVows();
applySnapshot(history[0] || makeSnapshot());

/* addOverlay */
function addOverlay(src, isVow=false){
  const newImg = document.createElement("img");
  newImg.src = src;
  newImg.classList.add("overlay");
  if(isVow) newImg.classList.add("vow");
  collage.appendChild(newImg);
}

/* UPDATE –∫–Ω–æ–ø–∫–∞ (–æ–±—Ö—ñ–¥ –∫–µ—à—É) */
document.getElementById('updateBtn').addEventListener('click', function () {
  const url = window.location.href.split('?')[0];
  window.location.href = url + '?_=' + new Date().getTime();
});
</script>
</body>
</html>
