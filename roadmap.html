<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî –≥–æ—Ç–æ–≤–∞ –≥–∞–ª–µ—Ä–µ—è</title>
<style>
  body{ text-align:center; font-family:Arial, sans-serif; background:#f5f5f5; }
  .venwin{ background:#fff; border-radius:10px; padding:10px; display:inline-block; margin-top:10px;}
  canvas{ border:3px solid #bbb; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:block; margin:10px auto; }
  button{ padding:8px 12px; margin:5px; }
  .disabled{ pointer-events:none; opacity:.5; filter:grayscale(100%); }

  /* –ì–∞–ª–µ—Ä–µ—è */
  .gallery-container{ display:flex; justify-content:center; gap:20px; margin:15px auto; flex-wrap:wrap;}
  .gallery-block{ display:flex; flex-direction:column; align-items:center; gap:10px; }
  .thumbnails{ display:flex; gap:10px; overflow:hidden; justify-content:center;}
  .thumb-wrapper{ position:relative; }
  .thumb{ width:108px; height:72px; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 0 6px rgba(0,0,0,0.3); transition:all 0.3s; z-index:1;}
  .imagbox{ position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) scale(0.1); opacity:0; transition:all 0.5s ease; z-index:9999; border-radius:12px; box-shadow:0 0 25px rgba(0,0,0,0.7); pointer-events:none; background:#fff;}
  .thumb-wrapper:hover .imagbox{ opacity:1; transform:translate(-50%, -50%) scale(0.6);}
  .arrow{ font-size:20px; cursor:pointer; user-select:none; padding:3px; display:flex; align-items:center; justify-content:center;}
  .gallery-container.vows .labels{ display:grid; grid-template-columns:repeat(4,1fr); text-align:center; margin-bottom:5px;}
  .gallery-container.vows .labels .label1{ grid-column:1; font-weight:bold; margin-left:70px;}
  .gallery-container.vows .labels .label2{ grid-column:3; font-weight:bold;}
</style>
</head>
<body>

<!-- Canvas –∑–≤–µ—Ä—Ö—É -->
<div class="venwin">
  <canvas id="canvas" width="900" height="600"></canvas>
</div>

<!-- –ì–∞–ª–µ—Ä–µ—ó –ø–æ—Å–µ—Ä–µ–¥–∏–Ω—ñ -->
<div class="gallery-container">
  <!-- –§–æ–Ω–∏ -->
  <div class="gallery-block">
    <b>–§–æ–Ω</b>
    <div>
      <span class="arrow" onclick="prevSlide()">&#10094;</span>
      <div class="thumbnails" id="thumbs"></div>
      <span class="arrow" onclick="nextSlide()">&#10095;</span>
    </div>
  </div>

  <!-- –§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö -->
  <div class="gallery-block">
    <b>–§–æ—Ç–æ</b>
    <label id="fot" title="–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö" style="width:108px;height:72px;background:#ddd;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:8px;">+</label>
  </div>
</div>

<!-- –ì–∞–ª–µ—Ä–µ—è –∫–ª—è—Ç–≤ -->
<div class="gallery-container vows">
  <div class="gallery-block">
    <div class="labels">
      <span class="label1">–ù–∞–¥–ø–∏—Å</span>
      <span class="label2">–ö–ª—è—Ç–≤–∞ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö</span>
    </div>
    <div>
      <span class="arrow" onclick="prevVow()">&#10094;</span>
      <div class="thumbnails" id="thumbsVows"></div>
      <span class="arrow" onclick="nextVow()">&#10095;</span>
    </div>
  </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
<div class="venwin">
  <button id="undoBtn">‚ü≤ Undo</button>
  <button id="previewBtn">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
  <button id="downloadBtn" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1" style="width:400px;">
</div>

<!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ input -->
<input type="file" id="bgLoader" accept="image/*" style="display:none">
<input type="file" id="loveLoader" accept="image/*" style="display:none">

<script>
/* === –ë–ê–ó–û–í–ò–ô –†–ï–î–ê–ö–¢–û–† === */
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const bgLoader=document.getElementById('bgLoader');
const loveLoader=document.getElementById('loveLoader');
const scaleSlider=document.getElementById('scaleSlider');
const undoBtn=document.getElementById('undoBtn');
const previewBtn=document.getElementById('previewBtn');
const downloadBtn=document.getElementById('downloadBtn');

const template=new Image();
template.src='images/composit.png';
const HOLE_OFFSET_X=6, HOLE_OFFSET_Y=-115, HOLE_RADIUS=98;
let mask={cx:0,cy:0,r:0};
function setDefaultMask(){mask.cx=canvas.width/2+HOLE_OFFSET_X;mask.cy=canvas.height/2+HOLE_OFFSET_Y;mask.r=HOLE_RADIUS;}

let layers={bg:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},love:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1}};
let activeLayer=null, previewMode=false, bgHoleActive=false;
const history=[], MAX_HISTORY=20;
function makeSnapshot(){return {bg:{...layers.bg},love:{...layers.love},previewMode,activeLayer,bgHoleActive};}
function pushHistory(){history.push(makeSnapshot());if(history.length>MAX_HISTORY)history.shift();}
function applySnapshot(s){
  previewMode=!!s.previewMode; activeLayer=s.activeLayer||null; bgHoleActive=!!s.bgHoleActive;
  const jobs=[];
  ['bg','love'].forEach(k=>{
    const v=s[k];
    if(v && v.src){
      const img=new Image();
      const p=new Promise(res=>{img.onload=()=>{layers[k].img=img;layers[k].src=v.src;layers[k].x=v.x;layers[k].y=v.y;layers[k].scale=v.scale;res();}; img.onerror=()=>{layers[k].img=null;layers[k].src=null;res();};});
      img.src=v.src; jobs.push(p);
    } else {layers[k].img=null; layers[k].src=null; layers[k].x=v?v.x:canvas.width/2; layers[k].y=v?v.y:canvas.height/2; layers[k].scale=v?v.scale:1;}
  });
  toggleButtons();
  if(jobs.length)return Promise.all(jobs).then(drawAll);
  drawAll(); return Promise.resolve();
}

pushHistory();

function drawLayerTo(ctxTarget,layer){if(!layer||!layer.img)return; const w=layer.img.width*layer.scale,h=layer.img.height*layer.scale;ctxTarget.drawImage(layer.img,layer.x-w/2,layer.y-h/2,w,h);}
function drawLove(ctxTarget,clip=false){const L=layers.love;if(!L||!L.img)return; const w=L.img.width*L.scale,h=L.img.height*L.scale; ctxTarget.save(); if(clip&&mask.r>0){ctxTarget.beginPath();ctxTarget.arc(mask.cx,mask.cy,mask.r,0,Math.PI*2);ctxTarget.clip();} ctxTarget.drawImage(L.img,L.x-w/2,L.y-h/2,w,h); ctxTarget.restore();}
function drawBgWithHole(ctxTarget){if(!layers.bg.img)return;if(!bgHoleActive||mask.r<=0){drawLayerTo(ctxTarget,layers.bg);return;} const off=document.createElement('canvas'); off.width=canvas.width; off.height=canvas.height; const octx=off.getContext('2d'); drawLayerTo(octx,layers.bg); octx.globalCompositeOperation='destination-out'; octx.beginPath(); octx.arc(mask.cx,mask.cy,mask.r,0,Math.PI*2); octx.fill(); octx.globalCompositeOperation='source-over'; ctxTarget.drawImage(off,0,0);}
function drawAll(){ctx.clearRect(0,0,canvas.width,canvas.height); if(!previewMode){drawBgWithHole(ctx); drawLove(ctx,false);}else{drawLove(ctx,true); drawBgWithHole(ctx);} if(template.complete)ctx.drawImage(template,0,0,canvas.width,canvas.height);}
function toggleButtons(){if(previewMode){previewBtn.style.display='none'; downloadBtn.style.display='inline-block'; setDisabled(true);}else{previewBtn.style.display='inline-block'; downloadBtn.style.display='none'; setDisabled(false);}}

function handleFileLoad(file,key){if(!file)return; const reader=new FileReader(); reader.onload=e=>{const data=e.target.result; const img=new Image(); img.onload=()=>{layers[key].img=img; layers[key].src=data; layers[key].x=canvas.width/2; layers[key].y=canvas.height/2; layers[key].scale=1; activeLayer=key; scaleSlider.value=1; pushHistory(); drawAll();}; img.src=data;}; reader.readAsDataURL(file);}
bgLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'bg'));
loveLoader.addEventListener('change',e=>handleFileLoad(e.target.files[0],'love'));

scaleSlider.addEventListener('input',()=>{if(!activeLayer)return; layers[activeLayer].scale=parseFloat(scaleSlider.value); drawAll();});

let dragging=false, dragStartX=0, dragStartY=0;
canvas.addEventListener('mousedown',e=>{if(previewMode||!activeLayer)return; dragging=true; dragStartX=e.offsetX-layers[activeLayer].x; dragStartY=e.offsetY-layers[activeLayer].y;});
canvas.addEventListener('mousemove',e=>{if(previewMode||!dragging||!activeLayer)return; layers[activeLayer].x=e.offsetX-dragStartX; layers[activeLayer].y=e.offsetY-dragStartY; drawAll();});
function stopDrag(){if(previewMode)return;if(dragging){dragging=false; pushHistory();}}
canvas.addEventListener('mouseup',stopDrag);
canvas.addEventListener('mouseleave',stopDrag);
canvas.addEventListener('touchstart',e=>{if(previewMode||!activeLayer)return; const t=e.touches[0],rect=canvas.getBoundingClientRect(); dragging=true; dragStartX=t.clientX-rect.left-layers[activeLayer].x; dragStartY=t.clientY-rect.top-layers[activeLayer].y; e.preventDefault();});
canvas.addEventListener('touchmove',e=>{if(previewMode||!dragging||!activeLayer)return; const t=e.touches[0],rect=canvas.getBoundingClientRect(); layers[activeLayer].x=t.clientX-rect.left-dragStartX; layers[activeLayer].y=t.clientY-rect.top-dragStartY; drawAll(); e.preventDefault();});
canvas.addEventListener('touchend',stopDrag);

undoBtn.addEventListener('click',()=>{if(history.length<=1)return; history.pop(); applySnapshot(history[history.length-1]);});
previewBtn.addEventListener('click',()=>{previewMode=true; pushHistory(); toggleButtons(); drawAll();});
downloadBtn.addEventListener('click',()=>{const link=document.createElement('a'); link.download='composition.png'; link.href=canvas.toDataURL('image/png'); link.click();});
template.onload=()=>{setDefaultMask(); drawAll();};
applySnapshot(history[0]||makeSnapshot());
function setDisabled(state){[bgLoader,loveLoader,scaleSlider].forEach(el=>{el.disabled=!!state; el.classList.toggle('disabled',!!state);});}

/* === –ì–ê–õ–ï–†–ï–Ø –§–û–ù–Ü–í === */
const url="https://detectfraud.github.io/gallery/";
const images=["nature(1)","nature(2)","nature(3)","nature(4)","nature(5)","nature(6)","nature(7)","nature(8)","nature(9)","Fon"];
let fullImages=images.map(n=>url+n+".jpeg"), startIndex=0;
const thumbsContainer=document.getElementById("thumbs");
function createThumb(src,isVow=false){
  const wrapper=document.createElement("div"); wrapper.className="thumb-wrapper";
  const imgName=src.split("/").pop().split(".")[0];
  const thumb=document.createElement("img"); thumb.className="thumb"; thumb.src=src;
  const big=document.createElement("img"); big.className="imagbox"; big.src=src;
  if(!isVow && imgName==="Fon"){ thumb.title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤—ñ–π —Ñ–æ–Ω"; thumb.onclick=()=>bgLoader.click(); } else { thumb.onclick=()=>handleFileLoad({name:src},"love");}
  wrapper.appendChild(thumb); wrapper.appendChild(big); thumbsContainer.appendChild(wrapper);
}
function renderThumbnails(){thumbsContainer.innerHTML=""; fullImages.slice(startIndex,startIndex+3).forEach(src=>createThumb(src,false));}
function prevSlide(){startIndex=(startIndex-3+fullImages.length)%fullImages.length; renderThumbnails();}
function nextSlide(){startIndex=(startIndex+3)%fullImages.length; renderThumbnails();}
renderThumbnails();

/* === –ì–∞–ª–µ—Ä–µ—è –∫–ª—è—Ç–≤ === */
const vows=["LoveStones","Eternity","Fidelity","Joy","LoveStones","Love","Strength","Tenderness","LoveStones","Trust","Unity","Heart"];
const fullVows=vows.map(n=>url+n+".png");
let vowIndex=0, thumbsVows=document.getElementById("thumbsVows");
function createVowThumb(src){const wrapper=document.createElement("div"); wrapper.className="thumb-wrapper"; const thumb=document.createElement("img"); thumb.className="thumb"; thumb.src=src; thumb.onclick=()=>handleFileLoad({name:src},"love"); wrapper.appendChild(thumb); thumbsVows.appendChild(wrapper);}
function renderVows(){thumbsVows.innerHTML=""; fullVows.slice(vowIndex,vowIndex+4).forEach(src=>createVowThumb(src));}
function prevVow(){vowIndex=(vowIndex-4+fullVows.length)%fullVows.length; renderVows();}
function nextVow(){vowIndex=(vowIndex+4)%fullVows.length; renderVows();}
renderVows();

/* === –ö–Ω–æ–ø–∫–∞ –§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö === */
document.getElementById("fot").onclick=()=>loveLoader.click();
</script>
</body>
</html>
