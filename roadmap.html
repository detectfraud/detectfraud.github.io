<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ö–∞–º—ñ–Ω—å –ª—é–±–æ–≤—ñ ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä + –ì–∞–ª–µ—Ä–µ—ó</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; background: #f5f5f5; }
.venwin{ background:#fff; border-radius:10px; padding:10px; display:inline-block; margin-top:20px; }
canvas{ border:3px solid #bbb; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.1); display:block; margin:0 auto 20px; }
button{ padding:8px 12px; margin:0 5px; }
.disabled{ pointer-events:none; opacity:.5; filter:grayscale(100%); }

/* === –ì–∞–ª–µ—Ä–µ—ó === */
.gallery-container { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-bottom:20px; }
.gallery-block { display:flex; flex-direction:column; align-items:center; gap:10px; }
.thumbnails { display:flex; gap:10px; overflow:hidden; justify-content:center; }
.thumb-wrapper { position:relative; }
.thumb { width:108px; height:72px; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 0 6px rgba(0,0,0,0.3); transition:0.3s; }
.collage img.overlay { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; pointer-events:none; }

.arrow, .arow { font-size:20px; cursor:pointer; user-select:none; padding:3px; line-height:1; display:flex; align-items:center; justify-content:center; z-index:3; }
.gallery-container.vows .labels { display:grid; grid-template-columns:repeat(4,1fr); text-align:center; margin-bottom:5px; }
.gallery-container.vows .labels .label1 { grid-column:1; font-weight:bold; margin-left:70px; }
.gallery-container.vows .labels .label2 { grid-column:3; font-weight:bold; }
#fot { display:inline-block; cursor:pointer; border-radius:8px; width:108px; height:72px; background-image:url(https://detectfraud.github.io/gallery/Para.png); background-size:contain; background-repeat:no-repeat; }
#fot:hover { mix-blend-mode: luminosity; }
</style>
</head>
<body>

<!-- Canvas –∑–≤–µ—Ä—Ö—É -->
<div class="venwin">
  <canvas id="canvas" width="900" height="600"></canvas>
</div>

<!-- –ì–∞–ª–µ—Ä–µ—ó –ø–æ—Å–µ—Ä–µ–¥–∏–Ω—ñ -->
<div class="gallery-container">
  <div class="gallery-block">
    <b>–§–æ–Ω</b>
    <div>
      <span class="arrow" onclick="prevSlide()">&#10094;</span>
      <div class="thumbnails" id="thumbs"></div>
      <span class="arrow" onclick="nextSlide()">&#10095;</span>
    </div>
  </div>

  <div class="gallery-block">
    <b>–§–æ—Ç–æ</b>
    <label id="fot" title="–§–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö"></label>
  </div>
</div>

<div class="gallery-container vows">
  <div class="gallery-block">
    <div class="labels">
      <span class="label1">–ù–∞–¥–ø–∏—Å</span>
      <span class="label2">–ö–ª—è—Ç–≤–∞ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö</span>
    </div>
    <div class="gallery-row">
      <span class="arow" onclick="prevVow()">&#10094;</span>
      <div class="thumbnails" id="thumbsVows"></div>
      <span class="arow" onclick="nextVow()">&#10095;</span>
    </div>
  </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –∑–Ω–∏–∑—É -->
<div class="venwin">
  <input type="range" id="scaleSlider" min="0.1" max="3" step="0.01" value="1"><br><br>
  <button id="undoBtn">‚ü≤ Undo</button>
  <button id="previewBtn">üëÅ –ü–µ—Ä–µ–≥–ª—è–¥</button>
  <button id="downloadBtn" style="display:none;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
</div>

<!-- –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ —ñ–Ω–ø—É—Ç–∏ -->
<input type="file" id="bgLoader" accept="image/*" style="display:none">
<input type="file" id="loveLoader" accept="image/*" style="display:none">

<script>
/* === Canvas –ª–æ–≥—ñ–∫–∞ (–†–µ–¥–∞–∫—Ç–æ—Ä) === */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const scaleSlider = document.getElementById('scaleSlider');
const undoBtn = document.getElementById('undoBtn');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');

const template = new Image();
template.src = 'images/composit.png';

const HOLE_OFFSET_X=6, HOLE_OFFSET_Y=-115, HOLE_RADIUS=98;
let mask={cx:0,cy:0,r:0};
function setDefaultMask(){ mask.cx=canvas.width/2+HOLE_OFFSET_X; mask.cy=canvas.height/2+HOLE_OFFSET_Y; mask.r=HOLE_RADIUS; }

let layers={
  bg:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},
  love:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1},
  loveExtra:{img:null,src:null,x:canvas.width/2,y:canvas.height/2,scale:1}
};
let activeLayer=null, previewMode=false, bgHoleActive=false;

const history=[], MAX_HISTORY=20;
function makeSnapshot(){ return {bg:{...layers.bg}, love:{...layers.love}, loveExtra:{...layers.loveExtra}, previewMode, activeLayer, bgHoleActive}; }
function pushHistory(){ history.push(makeSnapshot()); if(history.length>MAX_HISTORY) history.shift(); }
function applySnapshot(s){
  previewMode=!!s.previewMode; activeLayer=s.activeLayer||null; bgHoleActive=!!s.bgHoleActive;
  ['bg','love','loveExtra'].forEach(k=>{
    const v=s[k]; if(v && v.src){ const img=new Image(); img.onload=()=>{ layers[k].img=img; layers[k]=v; drawAll(); }; img.src=v.src; } else layers[k]=v||layers[k];
  });
  toggleButtons();
  drawAll();
}

/* –ú–∞–ª—é–≤–∞–Ω–Ω—è */
function drawLayer(l){ if(!l.img) return; const w=l.img.width*l.scale,h=l.img.height*l.scale; ctx.drawImage(l.img,l.x-w/2,l.y-h/2,w,h); }
function drawLove(l,clip=false){ if(!l.img)return; const w=l.img.width*l.scale,h=l.img.height*l.scale; ctx.save(); if(clip&&mask.r>0){ctx.beginPath();ctx.arc(mask.cx,mask.cy,mask.r,0,2*Math.PI);ctx.clip();} ctx.drawImage(l.img,l.x-w/2,l.y-h/2,w,h); ctx.restore(); }
function drawBgWithHole(){ if(!layers.bg.img){ctx.clearRect(0,0,canvas.width,canvas.height); return;} if(!bgHoleActive||mask.r<=0){drawLayer(layers.bg); return;} const off=document.createElement('canvas'); off.width=canvas.width; off.height=canvas.height; const octx=off.getContext('2d'); drawLayer(layers.bg); octx.globalCompositeOperation='destination-out'; octx.beginPath(); octx.arc(mask.cx,mask.cy,mask.r,0,2*Math.PI); octx.fill(); octx.globalCompositeOperation='source-over'; ctx.drawImage(off,0,0); }
function drawAll(){ ctx.clearRect(0,0,canvas.width,canvas.height); if(!previewMode){ drawBgWithHole(); drawLove(layers.love); drawLove(layers.loveExtra); }else{ drawLove(layers.love,true); drawLove(layers.loveExtra,true); drawBgWithHole(); } if(template.complete)ctx.drawImage(template,0,0,canvas.width,canvas.height); }

function toggleButtons(){ if(previewMode){ previewBtn.style.display='none'; downloadBtn.style.display='inline-block'; setDisabled(true); }else{ previewBtn.style.display='inline-block'; downloadBtn.style.display='none'; setDisabled(false); } }

/* –ú–∞—Å—à—Ç–∞–± */
scaleSlider.addEventListener('input',()=>{ if(!activeLayer)return; layers[activeLayer].scale=parseFloat(scaleSlider.value); drawAll(); });

/* Dragging */
let dragging=false, dragStartX=0, dragStartY=0;
canvas.addEventListener('mousedown',e=>{ if(previewMode||!activeLayer)return; dragging=true; dragStartX=e.offsetX-layers[activeLayer].x; dragStartY=e.offsetY-layers[activeLayer].y; });
canvas.addEventListener('mousemove',e=>{ if(previewMode||!dragging||!activeLayer)return; layers[activeLayer].x=e.offsetX-dragStartX; layers[activeLayer].y=e.offsetY-dragStartY; drawAll(); });
function stopDrag(){ if(previewMode)return; if(dragging){ dragging=false; pushHistory(); } }
canvas.addEventListener('mouseup',stopDrag);
canvas.addEventListener('mouseleave',stopDrag);
canvas.addEventListener('touchstart',e=>{ if(previewMode||!activeLayer)return; const t=e.touches[0],rect=canvas.getBoundingClientRect(); dragging=true; dragStartX=t.clientX-rect.left-layers[activeLayer].x; dragStartY=t.clientY-rect.top-layers[activeLayer].y; e.preventDefault(); });
canvas.addEventListener('touchmove',e=>{ if(previewMode||!dragging||!activeLayer)return; const t=e.touches[0],rect=canvas.getBoundingClientRect(); layers[activeLayer].x=t.clientX-rect.left-dragStartX; layers[activeLayer].y=t.clientY-rect.top-dragStartY; drawAll(); e.preventDefault(); });
canvas.addEventListener('touchend',stopDrag);

/* Undo / Preview / Download */
undoBtn.addEventListener('click',()=>{ if(history.length<=1)return; history.pop(); applySnapshot(history[history.length-1]); });
previewBtn.addEventListener('click',()=>{ previewMode=true; pushHistory(); toggleButtons(); drawAll(); });
downloadBtn.addEventListener('click',()=>{ const link=document.createElement('a'); link.download='composition.png'; link.href=canvas.toDataURL('image/png'); link.click(); });

function setDisabled(state){ [bgLoader,loveLoader,scaleSlider].forEach(el=>{ el.disabled=!!state; el.classList.toggle('disabled',!!state); }); }

/* Template onload */
template.onload=()=>{ setDefaultMask(); drawAll(); };
pushHistory();

/* === –ì–∞–ª–µ—Ä–µ—è —Ñ–æ–Ω—ñ–≤ === */
const url="https://detectfraud.github.io/gallery/";
const images=["nature(1)","nature(2)","nature(3)","nature(4)","nature(5)","nature(6)","nature(7)","nature(8)","nature(9)","Fon"];
let fullImages=images.map(n=>url+n+".jpeg");
let startIndex=0;
const thumbsContainer=document.getElementById("thumbs");
function renderThumbnails(){ thumbsContainer.innerHTML=""; const slice=fullImages.slice(startIndex,startIndex+3); slice.forEach(src=>createThumb(src,thumbsContainer,false)); }
function createThumb(src,container,isVow){ const wrapper=document.createElement("div"); wrapper.className="thumb-wrapper"; const imgName=src.split("/").pop().split(".")[0]; const thumb=document.createElement("img"); thumb.className="thumb"; thumb.src=src; if(!isVow && imgName==="Fon"){ thumb.title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤—ñ–π —Ñ–æ–Ω"; thumb.onclick=()=>bgLoader.click(); } else thumb.onclick=()=>addOverlay(src,isVow); wrapper.appendChild(thumb); container.appendChild(wrapper); }
function prevSlide(){ startIndex=(startIndex-3+fullImages.length)%fullImages.length; renderThumbnails(); }
function nextSlide(){ startIndex=(startIndex+3)%fullImages.length; renderThumbnails(); }

/* –ì–∞–ª–µ—Ä–µ—è –∫–ª—è—Ç–≤ */
const vows=["LoveStones","Eternity","Fidelity","Joy","LoveStones","Love","Strength","Tenderness","LoveStones","Trust","Unity","Heart"];
const fullVows=vows.map(n=>url+n+".png"); let vowIndex=0; const thumbsVows=document.getElementById("thumbsVows");
function renderVows(){ thumbsVows.innerHTML=""; const slice=fullVows.slice(vowIndex,vowIndex+4); slice.forEach(src=>createThumb(src,thumbsVows,true)); }
function prevVow(){ vowIndex=(vowIndex-4+fullVows.length)%fullVows.length; renderVows(); }
function nextVow(){ vowIndex=(vowIndex+4)%fullVows.length; renderVows(); }

/* –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–∞ canvas */
function addOverlay(src,isVow=false){
  const img=new Image();
  img.onload=()=>{
    if(isVow) layers.loveExtra.img=img; else layers.loveExtra.img=img;
    layers.loveExtra.src=src;
    layers.loveExtra.x=canvas.width/2; layers.loveExtra.y=canvas.height/2;
    activeLayer='loveExtra'; scaleSlider.value=1; pushHistory(); drawAll();
  };
  img.src=src;
}

/* –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ–≥–æ —Ñ–æ–Ω—É */
bgLoader.addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader(); reader.onload=ev=>{
    const img=new Image(); img.onload=()=>{
      layers.bg.img=img; layers.bg.src=ev.target.result; layers.bg.x=canvas.width/2; layers.bg.y=canvas.height/2; layers.bg.scale=1;
      activeLayer='bg'; scaleSlider.value=1; pushHistory(); drawAll();
    }; img.src=ev.target.result;
  }; reader.readAsDataURL(file);
});

/* –ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ –∑–∞–∫–æ—Ö–∞–Ω–∏—Ö */
document.getElementById("fot").onclick=()=>loveLoader.click();
loveLoader.addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader(); reader.onload=ev=>{
    const img=new Image(); img.onload=()=>{
      layers.loveExtra.img=img; layers.loveExtra.src=ev.target.result;
      layers.loveExtra.x=canvas.width/2; layers.loveExtra.y=canvas.height/2;
      activeLayer='loveExtra'; scaleSlider.value=1; pushHistory(); drawAll();
    }; img.src=ev.target.result;
  }; reader.readAsDataURL(file);
});

// –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–µ–Ω–¥–µ—Ä
renderThumbnails();
renderVows();

</script>
</body>
</html>

